<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/icon/cat.png"><link rel="icon" href="/img/icon/cat.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="咖啡猫"><meta name="keywords" content=""><meta name="description" content="zookeeper"><meta property="og:type" content="article"><meta property="og:title" content="Zookeeper"><meta property="og:url" content="https://www.wujunshen.cn/posts/987247817.html"><meta property="og:site_name" content="咖啡猫"><meta property="og:description" content="zookeeper"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.wujunshen.cn/img/jetbrain/1920x1080-phpstorm2022_1.png"><meta property="article:published_time" content="2022-05-16T06:55:32.000Z"><meta property="article:modified_time" content="2022-05-30T12:16:00.000Z"><meta property="article:author" content="咖啡猫"><meta property="article:tag" content="中间件"><meta property="article:tag" content="zookeeper"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://www.wujunshen.cn/img/jetbrain/1920x1080-phpstorm2022_1.png"><title>Zookeeper - 咖啡猫</title><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/hint.css@2/hint.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prismjs@1/plugins/line-numbers/prism-line-numbers.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"www.wujunshen.cn",root:"/",version:"1.8.14",typing:{enable:!1,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,baidu:"29d28856048f5cb020dac5f5c6add7a9",google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:"https://aotnutqx.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!0,appId:"AotNUTqXh4KxbyAqtWFR9PH6-gzGzoHsz",appKey:"cqckpd2YjhM5GWX2Ew4tKNyY",counter:{enable:!0},visitor:{enable:!0},like:{enable:!0}}},search_path:"/local-search.xml"}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script src="/js/statistics.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>咖啡猫</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> 图书馆</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/ElasticSearch/">ElasticSearch </a><a class="dropdown-item" href="/Kafka/">Kafka </a><a class="dropdown-item" href="/RabbitMQ/">RabbitMQ </a><a class="dropdown-item" href="/Zookeeper/">Zookeeper </a><a class="dropdown-item" href="/Redis/">Redis </a><a class="dropdown-item" href="/mysql/">Mysql </a><a class="dropdown-item" href="/Dubbo/">Dubbo </a><a class="dropdown-item" href="/%E5%8D%8F%E8%AE%AE/">协议 </a><a class="dropdown-item" href="/Socket/">Socket </a><a class="dropdown-item" href="/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/">函数式编程 </a><a class="dropdown-item" href="/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式 </a><a class="dropdown-item" href="/Istio/">Istio </a><a class="dropdown-item" href="/algorithm/">算法</a></div></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/page/post.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="Zookeeper">Zookeeper</span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> 咖啡猫 </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-05-16 14:55" pubdate>星期一, 五月 16日 2022, 2:55 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 13k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 107 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">Zookeeper</h1><p class="note note-info">本文最后更新于：星期一, 五月 30日 2022, 8:16 晚上</p><div class="markdown-body"><p>主要用途</p><ul><li>分布式集群的集中式元数据存储（Dubbo，Kafka，Hbase）</li><li>Master选举实现HA（高可用）架构（HDFS）</li><li>分布式协调和通知（Kafka）</li><li>分布式锁（java编写的分布式业务系统）</li></ul><h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><ul><li>数据模型节点: znode，可认为是一个节点，纯内存保存。和文件系统类似，有层级关系的树形文件结构</li><li>数据一致性: 任何一个zk节点收到写请求之后都会同步给其他机器，保证数据的强一致，连到任何一个zk节点看到的数据都是一致的</li><li>按顺序写: 只有一个zk节点可以写，所有节点都可读，所有写请求会分配一个集群全局唯一的递增编号，叫zxid，保证各客户端发起的写请求都是有序的</li><li>高可用: 只要不挂掉超过一半的节点，都能保证可用，数据不丢失</li><li>高性能: 每一个zk节点都在内存维护数据，所以集群绝对是高并发高性能的</li><li>高并发: 基于纯内存数据结构处理，并发能力高</li><li>集群化部署: 每个zk节点都在内存保存了zk的全部数据，各节点之间互相通信同步数据，客户端连接任何一节点都可访问数据</li></ul><p>如图</p><p><img src="/img/zookeeper/CCDA654CFB8190E20CAE89EEBB340AE9.jpg" srcset="/img/loading.gif" lazyload alt="架构"></p><p>下面根据上述几点依次说明</p><h2 id="数据模型节点"><a href="#数据模型节点" class="headerlink" title="数据模型节点"></a>数据模型节点</h2><p>zk节点有4种类型:</p><ol><li><p>PERSISTENT 持久化节点<br>节点创建后就一直存在的节点，除非有删除操作来主动删除这个节点。持久化节点的生命周期是永久有效的，不会因为创建该节点的客户端session失效而消失。（session概念见下文）</p></li><li><p>PERSISTENT_SEQUENTIAL 持久化顺序节点<br>这类节点的生命周期和持久化节点一致。额外特性是，在zk中，每个父节点会对它的第一级子节点维护一份顺序编码，记录每个子节点创建的先后顺序。如果创建子节点时，可以设置这个属性，那么在创建过程中，zk会自动为给定节点名加上一个表示顺序的数字后缀来作为新的节点名。这个后缀数字的值上限是整型的最大值。<br>如，创建节点时只需要传入节点“&#x2F;test_”, zk自动会在”test_”后面补充数字顺序</p></li><li><p>EPHEMERAL 临时节点<br>和持久化节点不同，临时节点的生命周期和客户端session绑定。也就是说，如果客户端session失效，这个节点就会被自动删除。注意，session失效不是连接断开。还要注意一件事，就是session失效后，所产生的节点也不是一下子就消失，也要过一段时间，大概是10秒以内。另外，临时节点下面不能创建子节点</p></li><li><p>EPHEMERAL_SEQUENTIAL 临时顺序节点<br>此节点属于临时节点，不过带有顺序编号，客户端session结束，所产生的节点就会消失</p></li></ol><p>节点分三种角色</p><ol><li>Leader 集群启动自动选举一个Leader出来，只有Leader是可写的</li><li>Follower 只能同步数据和提供数据的读取，Leader挂了，Follower可以继续选举新Leader</li><li>Observer 也是只读节点，但Observer不参与选举</li></ol><p>客户端跟zk建立连接是TCP长连接，建立了一个session，可通过心跳感知到session是否存在</p><p>sessionTimeout: 会话超时时间<br>如果客户端和ZK集群连接断开，只要客户端在指定sessionTimeout超时时间内重新连上一个zk节点，就能继续保持session，否则session就超时</p><h3 id="核心机制：Watcher监听回调"><a href="#核心机制：Watcher监听回调" class="headerlink" title="核心机制：Watcher监听回调"></a>核心机制：Watcher监听回调</h3><p>客户端可对znode进行Watcher监听，znode状态改变时回调通知客户端。</p><p>用于协调分布式系统:系统A监听一个数据变化，如果系统B更新了那个数据节点，zk反向通知系统A这个数据节点发生了变化</p><h2 id="数据一致性"><a href="#数据一致性" class="headerlink" title="数据一致性"></a>数据一致性</h2><p>通过ZAB协议（ZooKeeper Atomic Broadcast，ZooKeeper原子广播协议）来做数据同步，保证数据一致性。</p><p>协议本身按照之前所述节点类型，是leader和follower主从架构。只有leader可以进行写操作。读操作是leader和follower都可以。</p><h3 id="核心思想"><a href="#核心思想" class="headerlink" title="核心思想"></a>核心思想</h3><p>写过程采用2PC事务，过半follower提交机制</p><p>如图</p><p><img src="/img/zookeeper/130DDDCEEE94CD1F325B6C0440F0CAA0.jpg" srcset="/img/loading.gif" lazyload alt="ZAB"></p><p>整个过程是leader先收到写事务请求，转换成事务proposal（提议）同步给所有follower，每个follower如图左部红框，将proposal写入自己的磁盘日志文件中。然后发送个ack给leader，通知leader自己已收到proposal。</p><p>如果超过半数的follower向leader发起ack，反馈说已收到proposal，leader就再给所有follower发送一个commit信息，让所有follower正式提交写事务，将数据写入到各自的内存存储znode里。</p><p>如果leader挂机了，要重新选举leader，故障leader就算恢复了，也要变成follower。</p><h3 id="ZAB协议流程"><a href="#ZAB协议流程" class="headerlink" title="ZAB协议流程"></a>ZAB协议流程</h3><ol><li><p>集群启动<br>启动时，进入恢复模式，选举一个leader出来，然后leader等待集群中过半的follower跟它进行数据同步，只要过半follower完成数据同步，就退出恢复模式，开始对外提供服务了<br><strong>只要超过一半的节点，认可某节点是leader，就可以被选举为leader节点</strong></p></li><li><p>消息写入<br>进入消息广播模式，只有leader可以接受写请求，但客户端可随便连接leader或者follower，如果客户端连接到follower，follower会把写请求转发给leader<br>leader收到写请求，就把请求同步给所有的follower，过半follower发起ack说收到了，就再发commit给所有的follower，让大家提交写请求事务（见前述核心思想）</p></li><li><p>崩溃恢复<br>如果leader突然挂机，进入恢复模式，重新选举出一个leader节点，只要过半节点承认是leader，就可以选举出一个leader，所以zk很重要的一点是只要挂机的节点数小于整体节点数的一半，就可正常工作</p></li></ol><h4 id="zk数据一致性到底是强一致性还是最终一致性？"><a href="#zk数据一致性到底是强一致性还是最终一致性？" class="headerlink" title="zk数据一致性到底是强一致性还是最终一致性？"></a>zk数据一致性到底是强一致性还是最终一致性？</h4><p>首先搞清楚强一致性和最终一致性的概念</p><ul><li>强一致性<br>只要写入一条数据，立马无论从zk哪个节点上都可以读到这条数据，这就是强一致性。很明显，ZAB协议机制一看就不是强一致性。因为需要leader和全部follower节点都commit了之后，才能让数据写入操作返回，认为写入成功</li><li>最终一致性<br>写入一条数据，返回告知写入成功了，此时有可能马上去其他zk节点上查数据查不到，在短暂时间内是不一致的，但是过一会儿，最终这条数据一定是可以被查到的</li></ul><p>根据前述ZAB协议写入数据流程，过半follower对事务proposal发送ack给leader，leader再发送commit给所有follower，只有follower或者leader进行了commit，这个数据才会被客户端读取到。</p><p>那会有一种可能，就是有的follower已经commit了，但是有的follower还没有commit，这会导致某个客户端连接到follower01，可以读取到刚commit的数据，但连接到follower02，可能还没法读取到</p><p>所以zk不是强一致的，不是说leader节点必须保证一条数据被全部follower节点都commit了，才会读取到数据，而是过程中可能会在不同的follower上读取到不一致的数据，但最终一定会全部commit后达成数据一致</p><p>zk官方给自己的定义: <strong>顺序一致性</strong><br>也就是说zk是最终一致性的，但其实比最终一致性更好一点，因为leader节点一定会保证所有的proposal同步到follower上都是按照顺序来写入，起码顺序不会乱(见下文)。但是全部follower的数据一致确实是最终才能实现一致的</p><blockquote><p>如果非要求强一致性，可以手动调用zk的sync()操作</p></blockquote><h2 id="按顺序写"><a href="#按顺序写" class="headerlink" title="按顺序写"></a>按顺序写</h2><p>按照前述内容，leader节点发起事务Proposal的广播的事务提议，仅仅只是个提议而已，过半follower都ack，leader节点就直接发起commit消息到全部follower节点上，让大家提交；</p><p>这里leader节点发起事务proposal之前，会分配一个全局唯一递增的事务id叫zxid，通过这个zxid来严格保证写顺序，它会为每个follower节点创建一个队列，里面放入要发送给follower的事务proposal，这样来保证了数据同步的顺序性</p><p>每个follower节点收到事务proposal之后，需要立即写入本地磁盘日志中，写入成功之后就可保证数据不会丢失，然后发送一个ack给leader，过半follower都发送了ack，leader就推送commit消息给全部follower，<br>leader节点它自己也会进行commit操作</p><p>commit之后，就意味这个数据可以被读取到了。</p><h2 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h2><p>有两种数据不一致情况，zk会展现高可用特性，如下:</p><ol><li>leader收到了过半的follower的ack，接着leader自己commit了，还没来得及发送commit给所有follower自己就挂了，此时leader数据跟所有follower数据是不一致的，必须要保证全部follower最终都要commit<br>解决方案:<br>在老leader节点崩溃时，选举一个zxid最大的节点作为新leader节点，它来检查事务日志，如果发现自己磁盘日志里有一个proposal，但是还没提交，说明肯定是之前挂掉的leader没来得及发送commit就崩溃了。<br>此时新leader节点就得作为leader身份把这个proposal发送commit到其他所有的follower上，这就保证了之前老leader提交的事务最终会同步提交到所有follower那边</li><li>leader自己收到一个请求，结果没来得及发送proposal给所有follower，在这之前就挂了，此时这个leader上的请求应该是要被丢弃掉的<br>解决方案:<br>老leader节点自己磁盘日志里有一个事务proposal，它恢复启动后，作为follow节点和新leader进行同步，发现这个事务proposal其实是不应该存在的，就直接丢弃掉就可以了</li></ol><h3 id="情况1中，为啥老leader挂了，要选zxid最大的节点做新leader？"><a href="#情况1中，为啥老leader挂了，要选zxid最大的节点做新leader？" class="headerlink" title="情况1中，为啥老leader挂了，要选zxid最大的节点做新leader？"></a>情况1中，为啥老leader挂了，要选zxid最大的节点做新leader？</h3><p>举例:<br>假设zk集群是5个节点，1个leader + 4个follower</p><p>1个leader把proposal发送给4个follower，其中3个folower（过半）都收到了proposal发送ack给leader，第4个follower没收到proposal</p><p>此时leader执行commit之后挂了，commit没发送给其他的follower，剩余的4个follower，只要3个节点投票一个节点当leader，就是leader</p><p>假设那3个收到proposal的follower都投票第4个没收到proposal的follower当leader。那么这条数据一定永久性丢失了，因为新leader节点自身没有那个proposal，按照前述怎么会把proposal发送给其他所有follower？</p><p>所以只有选择一个拥有最大zxid的节点作为新leader，其他follower就会跟它进行同步，它给每个follower准备一个队列，然后把所有的proposal都发送给follower，只要过半follower都ack了，就会发送commit给那个follower</p><p>所谓的commit操作，就是把这条数据加入内存中的znode树形数据结构里去，然后对外就可以被看到了，也会去通知一些监听这个znode的客户端（还记得Watcher机制么？）</p><p>如果一个follower跟leader完全同步了，就会加入leader的同步follower列表中去，然后过半follower都同步完毕了，就可以对外继续提供服务了</p><h3 id="情况2中，如何发现并丢弃多余的proposal的？"><a href="#情况2中，如何发现并丢弃多余的proposal的？" class="headerlink" title="情况2中，如何发现并丢弃多余的proposal的？"></a>情况2中，如何发现并丢弃多余的proposal的？</h3><p>每一条事务的zxid是64位的，高32位是leader的epoch，可当做是leader的版本（其实不是）;低32位才是自增的zxid</p><p>假设老leader发送出去的proposal，高32位是1，低32位是11358</p><p>情况2中，新leader选举出来时，它的epoch会自增长一位。那么它的proposal，高32位是2，低32位是继续自增的zxid</p><p>然后老leader节点恢复连接了，到集群是follower了，此时发现自己比新leader多出来一条proposal，但是自己的epoch比新leader的epoch低，所以就会丢弃掉这条数据</p><h2 id="高性能"><a href="#高性能" class="headerlink" title="高性能"></a>高性能</h2><p>2PC中的过半写机制，只要一半以上的follower节点ack，leader就发送commit给所有follower节点，不用等所有follower节点都准备好发ack，可见性能做了优化</p><p>而且commit操作，是把数据写入内存中的znode树形数据结构里去，纯内存的数据结构能保证性能比较高</p><h2 id="高并发"><a href="#高并发" class="headerlink" title="高并发"></a>高并发</h2><p>前述节点的角色中，第3种角色 observer 节点是不参与leader选举的，也不参与ZAB协议同步时，过半follower去发送ack给leader的那个环节，它只是单纯的接收数据，同步数据，可能数据存在一定的不一致的问题，但是是只读的（zk集群中，只有leader节点可以写操作）</p><p>所以zk集群无论多少台机器，只能是一个leader进行写，单机写入最多每秒上万QPS，这是没法扩展的，所以zk适合写少的场景</p><p>但读呢？follower起码有2个或者4个，读起码可以有每秒几万QPS，如果读请求更多呢？此时就可以引入 observer 节点，她就只是同步数据，提供读服务的，所以可以无限的扩展 observer 节点</p><p>因此 observer 节点存在的意义就是线性扩展zk的读QPS</p><h2 id="集群化部署"><a href="#集群化部署" class="headerlink" title="集群化部署"></a>集群化部署</h2><p>zk集群节点数一般是奇数，因为5个节点可以挂2个，6个节点也可以挂2个，不能让超过一半的节点挂掉，所以5和6效果一致，那奇数个节点可以减少机器开销，</p><p>zk只能是小集群部署，适合读多写少场景</p><h3 id="为什么"><a href="#为什么" class="headerlink" title="为什么?"></a>为什么?</h3><p>假设有1个leader + 20个follower，21台机器，20个follower，一个写请求出去，leader要起码等待10台以上的follower返回ack，才能发送commit，才能写请求成功，性能极差</p><p>所以zk的ZAB协议就决定了1个leader + 2个follower的小集群就够了，写请求是无法扩展的，读请求如果量大，可以加 observer 节点，最终就是适合读多写少的场景</p><h1 id="Zookeeper分布式锁"><a href="#Zookeeper分布式锁" class="headerlink" title="Zookeeper分布式锁"></a>Zookeeper分布式锁</h1><h2 id="实现方案一"><a href="#实现方案一" class="headerlink" title="实现方案一"></a>实现方案一</h2><p>某客户端尝试创建临时 znode 节点，创建成功就获取这个锁；此时别的客户端来创建锁就会失败，只能注册个监听器监听这把锁。释放锁就是删除这个 znode 节点，一旦释放掉就会通知客户端，然后等待着的客户端就可再次重新获取锁。</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZooKeeperSession</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">CountDownLatch</span> connectedSemaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ZooKeeper</span> zookeeper<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">CountDownLatch</span> latch<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ZooKeeperSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>zookeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span><span class="token string">"192.168.31.187:2181,192.168.31.19:2181,192.168.31.227:2181"</span><span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeperWatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                connectedSemaphore<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ZooKeeper session established......"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 获取分布式锁
     * 
     * @param productId
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">acquireDistributedLock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token string">"/product-lock-"</span> <span class="token operator">+</span> productId<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            zookeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Ids</span><span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 相当于是给node注册一个监听器，去看看这个监听器是否存在</span>
                    <span class="token class-name">Stat</span> stat <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>stat <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>latch <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    zookeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Ids</span><span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ee<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>

        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 释放掉一个分布式锁
     * 
     * @param productId
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">releaseDistributedLock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> productId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token string">"/product-lock-"</span> <span class="token operator">+</span> productId<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            zookeeper<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"release the lock for product[id="</span> <span class="token operator">+</span> productId <span class="token operator">+</span> <span class="token string">"]......"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 建立zk session的watcher
     * 
     * @author bingo
     * @since 2018/11/29
     *
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ZooKeeperWatcher</span> <span class="token keyword">implements</span> <span class="token class-name">Watcher</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Receive watched event: "</span> <span class="token operator">+</span> event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">KeeperState<span class="token punctuation">.</span>SyncConnected</span> <span class="token operator">==</span> event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                connectedSemaphore<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>latch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 封装单例的静态内部类
     * 
     * @author bingo
     * @since 2018/11/29
     *
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ZooKeeperSession</span> instance<span class="token punctuation">;</span>

        <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
            instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeperSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ZooKeeperSession</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 获取单例
     * 
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ZooKeeperSession</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 初始化单例的便捷方法
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>假设如下执行序列：</p><ol><li>客户端1创建了znode节点&#x2F;lock，获得了锁</li><li>客户端1进入了长时间的GC pause</li><li>客户端1连接到zk的session过期了。znode节点&#x2F;lock被自动删除</li><li>客户端2创建了znode节点&#x2F;lock，从而获得了锁</li><li>客户端1从GC pause中恢复过来，它仍然认为自己持有锁</li></ol><p>最后，客户端1和客户端2都认为自己持有了锁，冲突~<br>所以使用下列方案二</p><h2 id="实现方案二"><a href="#实现方案二" class="headerlink" title="实现方案二"></a>实现方案二</h2><p>创建临时顺序节点。如果有一把锁，被多个客户端竞争，此时多个客户端排队，第一个拿到锁的客户端执行，执行完释放锁；排在后面的每个客户端都会去监听排在自己前面的那个客户端创建的 node ，一旦某个客户端释放了锁，zookeeper 通知排在它后面的客户端，后面的客户端一旦被通知到，就去获取锁，执行操作</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZooKeeperDistributedLock</span> <span class="token keyword">implements</span> <span class="token class-name">Watcher</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">ZooKeeper</span> zk<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> locksRoot <span class="token operator">=</span> <span class="token string">"/locks"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> productId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> waitNode<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> lockNode<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">CountDownLatch</span> latch<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">CountDownLatch</span> connectedLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> sessionTimeout <span class="token operator">=</span> <span class="token number">30000</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ZooKeeperDistributedLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> productId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>productId <span class="token operator">=</span> productId<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> address <span class="token operator">=</span> <span class="token string">"192.168.31.187:2181,192.168.31.19:2181,192.168.31.227:2181"</span><span class="token punctuation">;</span>
            zk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> sessionTimeout<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            connectedLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">KeeperState<span class="token punctuation">.</span>SyncConnected</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            connectedLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>latch <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">acquireDistributedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token function">waitForLock</span><span class="token punctuation">(</span>waitNode<span class="token punctuation">,</span> sessionTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
 		    <span class="token comment">// 传入进去的locksRoot + “/” + productId</span>
        <span class="token comment">// 假设productId代表了一个商品id，比如说1</span>
        <span class="token comment">// locksRoot = locks</span>
        <span class="token comment">// /locks/10000000000，/locks/10000000001，/locks/10000000002</span>
            lockNode <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>locksRoot <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> productId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span>OPEN_ACL_UNSAFE<span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span>EPHEMERAL_SEQUENTIAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
            <span class="token comment">// 看看刚创建的节点是不是最小的节点</span>
   	    <span class="token comment">// locks：10000000000，10000000001，10000000002</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> locks <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span>locksRoot<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>locks<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
            <span class="token keyword">if</span><span class="token punctuation">(</span>lockNode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>locksRoot<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span> locks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token comment">//如果是最小的节点,则表示取得锁</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
  
            <span class="token comment">//如果不是最小的节点，找到比自己小1的节点</span>
    <span class="token keyword">int</span> previousLockIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> locks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>lockNode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>locksRoot <span class="token operator">+</span> “<span class="token operator">/</span>” <span class="token operator">+</span> locks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
           	    previousLockIndex <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
     <span class="token punctuation">&#125;</span>
     
     <span class="token keyword">this</span><span class="token punctuation">.</span>waitNode <span class="token operator">=</span> locks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>previousLockIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">waitForLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> waitNode<span class="token punctuation">,</span> <span class="token keyword">long</span> waitTime<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Stat</span> stat <span class="token operator">=</span> zk<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>locksRoot <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> waitNode<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stat <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>latch <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 删除/locks/10000000000节点</span>
            <span class="token comment">// 删除/locks/10000000001节点</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"unlock "</span> <span class="token operator">+</span> lockNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            zk<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>lockNode<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lockNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            zk<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LockException</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span><span class="token class-name">String</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token class-name">LockException</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="ZK的临时顺序节点为啥被称之为实现ZK分布式锁的天然之选？"><a href="#ZK的临时顺序节点为啥被称之为实现ZK分布式锁的天然之选？" class="headerlink" title="ZK的临时顺序节点为啥被称之为实现ZK分布式锁的天然之选？"></a>ZK的临时顺序节点为啥被称之为实现ZK分布式锁的天然之选？</h2><h3 id="每一个节点都是一个天然的顺序发号器"><a href="#每一个节点都是一个天然的顺序发号器" class="headerlink" title="每一个节点都是一个天然的顺序发号器"></a>每一个节点都是一个天然的顺序发号器</h3><p>每一个节点下面创建临时顺序节点（EPHEMERAL_SEQUENTIAL），新的子节点后面会加上一个顺序编号。这个顺序编号是上一个生成的顺序编号加1。如，用一个发号的节点“&#x2F;test&#x2F;lock”为父亲节点，可以在这个父节点下面创建相同前缀的临时顺序子节点，假定相同的前缀为“&#x2F;test&#x2F;lock&#x2F;seq-”。如果是第一个创建的子节点，那么生成的子节点为&#x2F;test&#x2F;lock&#x2F;seq-0000000000，下一个节点则为&#x2F;test&#x2F;lock&#x2F;seq-0000000001，依次类推</p><p>如下图</p><p><img src="/img/zookeeper/74D199308F00ADAECBA8DE8680E3C0EE.jpg" srcset="/img/loading.gif" lazyload alt="节点图"></p><h3 id="节点的递增有序性可以确保锁的公平"><a href="#节点的递增有序性可以确保锁的公平" class="headerlink" title="节点的递增有序性可以确保锁的公平"></a>节点的递增有序性可以确保锁的公平</h3><p>zk 分布式锁，首先需要创建一个父节点，尽量是持久化节点，然后每个要获得锁的线程都在这个节点下创建一个临时顺序节点。由于zk节点是按照创建的顺序依次递增的，为了确保公平，可以简单地规定，编号最小的那个节点先获得锁。因此，每个线程在尝试占用锁之前，首先判断自己的编号是不是当前最小的，如果是，则获取到锁</p><h3 id="节点监听机制可以保障占有锁的传递有序而且高效"><a href="#节点监听机制可以保障占有锁的传递有序而且高效" class="headerlink" title="节点监听机制可以保障占有锁的传递有序而且高效"></a>节点监听机制可以保障占有锁的传递有序而且高效</h3><p>每个线程抢占锁之前，先抢号创建自己的ZNode。同样，释放锁的时候，就需要删除抢号的ZNode。在抢号成功之后，如果不是排号最小的节点，就处于等待通知的状态。等谁的通知？等前一个ZNode的通知！当前一个ZNode被删除时，就轮到了自己占有锁的时候。第一个通知第二个、第二个通知第三个，击鼓传花似的依次向后传递。</p><p>zk的节点监听机制能非常完美地实现这种击鼓传花似的信息传递。具体的方法是，每一个等通知的ZNode节点，只需监听或者监视编号在自己前面那个且紧挨在自己前面的那个节点。只要上一个节点被删除了，就再进行一次判断，看看自己是不是序号最小的那个节点，如果是，则获得锁。</p><p>这种优越的机制，能保证由于网络异常或者其他原因造成集群中占用锁的客户端失联时，锁能够被有效释放。一旦占用锁的客户端与zk集群服务器失去联系，这个临时ZNode也将被自动删除。排在它后面的那个节点也能收到删除事件，从而获得锁。所以，在创建节点时，尽量创建临时顺序节点</p><h3 id="节点监听机制能避免羊群效应"><a href="#节点监听机制能避免羊群效应" class="headerlink" title="节点监听机制能避免羊群效应"></a>节点监听机制能避免羊群效应</h3><p>何为<strong>羊群效应</strong>？<br>一个节点挂掉了，所有节点都去监听，然后作出反应，这样会给服务器带来巨大压力</p><p>首尾相接，后面监听前面的方式，可以避免羊群效应。有了临时顺序节点，当一个节点挂掉，只有它后面的那一个节点才能作出反应</p><h2 id="和Redis分布式锁对比"><a href="#和Redis分布式锁对比" class="headerlink" title="和Redis分布式锁对比"></a>和Redis分布式锁对比</h2><p>Redis分布式锁实现见Redis篇，这里只是比较一下各自优劣</p><ul><li><p>redis 分布式锁，需要客户端不断去尝试获取锁，比较消耗性能<br>zk 分布式锁，获取不到锁，注册个监听器即可，不需要不断主动尝试获取锁，性能开销较小</p></li><li><p>redis 获取锁的那个客户端要是挂了，那只能等待超时时间到了之后才能释放锁<br>zk 因为创建的是临时 znode 节点，只要客户端挂了，znode 就没了，此时就会自动释放锁</p></li><li><p>zk 分布式锁性能不高。原因是每次在创建锁和释放锁的过程中，都要动态创建、销毁临时节点来实现锁功能。zk中创建和删除节点只能通过leader节点来执行，然后leader节点还需要将数据同步到所有的follower节点上，这样频繁的网络通信，性能的短板就非常突出</p></li></ul><h3 id="对比总结"><a href="#对比总结" class="headerlink" title="对比总结"></a>对比总结</h3><p>redis 分布式锁适用于并发量很大、性能要求很高而可靠性问题可通过其他方案弥补的场景。<br>zk 分布式锁适用于高可用，而并发量不是太高的场景<br>所以，没有谁好谁坏的问题，而是谁更合适的问题~</p><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ol><li><a target="_blank" rel="noopener" href="https://gitee.com/shishan100/Java-Interview-Advanced">中华石杉–互联网Java进阶面试训练营</a></li><li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/4CUe7OpM6y1kQRK8TOC_qQ">基于Redis的分布式锁到底安全吗?(下)</a></li></ol><h1 id="推荐书单"><a href="#推荐书单" class="headerlink" title="推荐书单"></a><a href="/Zookeeper">推荐书单</a></h1></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a> <a class="hover-with-bg" href="/tags/zookeeper/">zookeeper</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/posts/4129633176.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Dubbo</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/posts/38366605.html"><span class="hidden-mobile">Socket</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://fastly.jsdelivr.net/npm/valine@1/dist/Valine.min.js",(function(){var i=Object.assign({appId:"AotNUTqXh4KxbyAqtWFR9PH6-gzGzoHsz",appKey:"cqckpd2YjhM5GWX2Ew4tKNyY",path:"window.location.pathname",placeholder:"说点什么吧...",avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!1,recordIP:!0,serverURLs:"",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{Fluid.plugins.initFancyBox("#valine .vcontent img:not(.vemoji)")})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><div style="font-size:.85rem"><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="/js/duration.js"></script></div></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">沪ICP备2022013557号-1</a></span></div></footer><script src="https://fastly.jsdelivr.net/npm/nprogress@0/nprogress.min.js"></script><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/nprogress@0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://fastly.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="https://fastly.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/local-search.js"></script><script src="/js/img-lazyload.js"></script><script src="https://fastly.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js"></script><script src="https://fastly.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="https://fastly.jsdelivr.net/npm/anchor-js@4/anchor.min.js"></script><script defer src="https://fastly.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?29d28856048f5cb020dac5f5c6add7a9";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script src="https://fastly.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://fastly.jsdelivr.net/npm/meting@1.2.0/dist/Meting.min.js"></script><script src="/js/boot.js"></script><script src="/js/backgroundize.js"></script><link defer rel="stylesheet" href="/css/backgroundize.css"><script src="/js/timevalid.js"></script><script src="/js/reward.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"right","width":120,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body></html>