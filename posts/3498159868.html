<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/icon/cat.png"><link rel="icon" href="/img/icon/cat.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="咖啡猫"><meta name="keywords" content=""><meta name="description" content="云原生的Istio集成服务"><meta property="og:type" content="article"><meta property="og:title" content="Istio"><meta property="og:url" content="https://www.wujunshen.cn/posts/3498159868.html"><meta property="og:site_name" content="咖啡猫"><meta property="og:description" content="云原生的Istio集成服务"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.wujunshen.cn/img/jetbrain/1920x1080-qodana2022_1.png"><meta property="article:published_time" content="2020-06-18T04:12:13.000Z"><meta property="article:modified_time" content="2022-05-30T12:21:18.000Z"><meta property="article:author" content="咖啡猫"><meta property="article:tag" content="云原生"><meta property="article:tag" content="Istio"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://www.wujunshen.cn/img/jetbrain/1920x1080-qodana2022_1.png"><title>Istio - 咖啡猫</title><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/hint.css@2/hint.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prismjs@1/plugins/line-numbers/prism-line-numbers.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"www.wujunshen.cn",root:"/",version:"1.8.14",typing:{enable:!1,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,baidu:"29d28856048f5cb020dac5f5c6add7a9",google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:"https://aotnutqx.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!0,appId:"AotNUTqXh4KxbyAqtWFR9PH6-gzGzoHsz",appKey:"cqckpd2YjhM5GWX2Ew4tKNyY",counter:{enable:!0},visitor:{enable:!0},like:{enable:!0}}},search_path:"/local-search.xml"}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script src="/js/statistics.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>咖啡猫</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> 图书馆</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/ElasticSearch/">ElasticSearch </a><a class="dropdown-item" href="/Kafka/">Kafka </a><a class="dropdown-item" href="/RabbitMQ/">RabbitMQ </a><a class="dropdown-item" href="/Zookeeper/">Zookeeper </a><a class="dropdown-item" href="/Redis/">Redis </a><a class="dropdown-item" href="/mysql/">Mysql </a><a class="dropdown-item" href="/Dubbo/">Dubbo </a><a class="dropdown-item" href="/%E5%8D%8F%E8%AE%AE/">协议 </a><a class="dropdown-item" href="/Socket/">Socket </a><a class="dropdown-item" href="/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/">函数式编程 </a><a class="dropdown-item" href="/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式 </a><a class="dropdown-item" href="/Istio/">Istio </a><a class="dropdown-item" href="/algorithm/">算法</a></div></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/page/post.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="Istio">Istio</span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> 咖啡猫 </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2020-06-18 12:12" pubdate>星期四, 六月 18日 2020, 12:12 中午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 5.6k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 47 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">Istio</h1><p class="note note-info">本文最后更新于：星期一, 五月 30日 2022, 8:21 晚上</p><div class="markdown-body"><h1 id="服务网格"><a href="#服务网格" class="headerlink" title="服务网格"></a>服务网格</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>服务网格是一个负责微服务之间网络通信的基础设施层，提供了管理、控制和监控网络通信的功能，本质上是Sidecar模式的网络拓扑形态</p><h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><ul><li>动态路由</li><li>故障注入</li><li>熔断</li><li>安全</li><li>多语言支持</li><li>多协议支持</li><li>指标和分布式追踪</li></ul><h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul><li>可见性（Visibility）<br>运行时指标<strong>遥测</strong>、分布式跟踪</li><li>可管理性（Manage Ability）<br>服务发现、负载均衡、运行时动态路由</li><li>健壮性（Resilience）<br>超时、重试、熔断等弹性能力</li><li>安全性（Security）<br>服务间访问控制、TLS加密通信</li></ul><blockquote><p>遥测（Telemetry）是工业上常用的一种术语，是指从远程设备中收集数据，并传输到接收设备进行监测。在软件开发中，遥测的含义引申为对各种指标（metric）数据进行收集，并监控、分析这些指标</p></blockquote><h1 id="Istio架构"><a href="#Istio架构" class="headerlink" title="Istio架构"></a>Istio架构</h1><p>业务代码无侵入和网络层的全权代理是服务网格重要的优势，从逻辑上分成数据平面（Data Plane）和控制平面（Control Plane）</p><ul><li><p>数据平面<br>由一组和业务服务成对出现的Sidecar代理（Envoy）构成，它的主要功能是接管服务的进出流量，传递并控制服务和Mixer组件的所有网络通信（Mixer稍后会介绍）</p></li><li><p>控制平面<br>主要包括Pilot、Mixer、Citadel和Galley4个组件，主要功能是通过配置和管理Sidecar代理来进行流量控制，并配置Mixer去执行策略和收集遥测数据</p></li></ul><p><img src="/img/istio/2ECC92ED-B776-4C12-B79F-B112C0995D7D.png" srcset="/img/loading.gif" lazyload alt="架构图"></p><p>Istio追求尽可能的透明，通过各种解耦设计让系统对内对外都没有依赖。同时，还提供了高度的扩展性。Istio认为随着应用的增长和服务的增多，<strong>扩展策略系统是最主要的需求</strong>，因此它被设计为以<strong>增量</strong>的方式进行扩展。可移植也是Istio在设计中充分考虑的因素，它被设计为支持多种平台，以便服务可以被方便地迁移到不同的云环境中</p><h1 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h1><h2 id="Envoy"><a href="#Envoy" class="headerlink" title="Envoy"></a>Envoy</h2><p>Envoy作为Sidecar代理本质上是一个为面向服务的架构而设计的7层代理和通信总线。基于C++11开发而成。除了具有强大的网络控制能力外，Envoy还可以将流量行为和数据提取出来发送给Mixer组件，用以进行监控</p><p>主要功能</p><ul><li>HTTP七层路由</li><li>支持gRPC、HTTP&#x2F;2</li><li>服务发现和动态配置</li><li>健康检查</li></ul><h2 id="Pilot"><a href="#Pilot" class="headerlink" title="Pilot"></a>Pilot</h2><p>Pilot是Istio实现流量管理的核心组件<br>主要作用是配置和管理Envoy代理。比如可以为代理之间设置特定的流量规则，或者配置超时、重试、熔断这样的弹性能力。<br>Pilot会将控制流量行为的路由规则转换为Envoy的配置，并在运行时将它们广播到Envoy。<br>另外，Pilot还能够把服务发现机制抽象出来并转换成API分发给Envoy，使得后者具有服务发现的能力</p><p>主要功能</p><ul><li>从平台（如Kubernetes）获取服务信息，完成服务发现</li><li>获取Istio的各项配置，转换成Envoy代理可读的格式并分发</li></ul><p><img src="/img/istio/43520D0D-3D2F-44BA-8DE9-46256242EA07.png" srcset="/img/loading.gif" lazyload alt="架构图"></p><p>维护一套独立于平台的服务规则，并提供了一个平台适配器，以便接入各种不同的平台。规则API对运维人员开放，使得他们可以设置想要的流量规则，Pilot会把这些配置好的规则通过Envoy API分发给Envoy代理，以使其执行指定的规则，还公开了用于服务发现并且可以动态更新负载均衡和路由表的API</p><h2 id="Mixer"><a href="#Mixer" class="headerlink" title="Mixer"></a>Mixer</h2><p>主要功能是提供策略控制，并从Envoy代理收集遥测数据。<br>每次网络通信时Envoy都会向Mixer发出预检要求，用来检测调用者的合法性。调用之后Envoy代理会发送遥测数据供Mixer收集。一般情况下Envoy可以缓存这些数据，不需要频繁地调用Mixer。</p><p>个人理解就是在网络通信之前提供API网关作用，通信之后，提供服务监控功能。并且有自己的缓存，不需要Enovy频繁调用它</p><p><img src="/img/istio/02621BB7-1FF4-48F7-8AE3-747D6D97B549.png" srcset="/img/loading.gif" lazyload alt="和Envoy交互图"></p><p>适配器是Mixer的重要组成部分，本质上是一个插件模型，每个插件叫作适配器。这项特性使得Mixer可以接入几乎任意的（只要定义好接口）后端基础设施。比如可以选择接入不同的日志收集器、监控工具和授权工具等；可以在运行时切换不同的适配器或者是打开（关闭）它们；还可以自定义适配器以满足特定需求。适配器极大提高了Mixer的扩展性，它让Istio的功能拥有了更多可能性</p><h2 id="Citadel"><a href="#Citadel" class="headerlink" title="Citadel"></a>Citadel</h2><p>与安全相关的组件，主要负责密钥和证书的管理。它可以提供服务间和终端用户的身份认证，还可以加密服务网格中的流量（不是Istio重点）</p><h2 id="Galley"><a href="#Galley" class="headerlink" title="Galley"></a>Galley</h2><p>2019年3月份发布的1.1版本中的新组件，现在是Istio主要的配置管理组件。</p><p>负责配置的获取、处理和分发。使用了一种叫作MCP（Mesh Configuration Protocol，网格配置协议）的协议与其他组件进行通信</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Istio架构分为数据平面和控制平面，使各个组件充分解耦，各司其职，这就是被称为第二代服务网格产品的原因。<br>数据平面即Envoy代理，负责流量的接管；<br>控制平面包含了Pilot、Mixer、Citadel和Galley，它们分别负责流量控制、策略控制、安全加固和数据收集。</p><p>通过这些组件的协同工作，Istio顺利地完成了<strong>流量管理、策略和遥测、可视化和安全</strong>这4大功能</p><h1 id="Pilot流量管理配置"><a href="#Pilot流量管理配置" class="headerlink" title="Pilot流量管理配置"></a>Pilot流量管理配置</h1><table><thead><tr><th align="left">配置资源</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">虚拟服务<br>VirtualService</td><td align="left">用来定义路由规则，控制请求如何被路由的服务</td></tr><tr><td align="left">目标规则<br>DestinationRule</td><td align="left">用来配置请求的策略</td></tr><tr><td align="left">服务入口<br>ServiceEntry</td><td align="left">主要用来定义从外部如何访问服务网格</td></tr><tr><td align="left">网关<br>Gateway</td><td align="left">在网格入口设置负载、控制流量等</td></tr></tbody></table><h2 id="VirtualService"><a href="#VirtualService" class="headerlink" title="VirtualService"></a>VirtualService</h2><p>主要功能<br>定义路由规则，使请求（流量）可以依据这些规则被分发到对应的服务。路由的方式也有很多种，可以根据请求的源或目标地址路由，也可以根据路径、头信息，或者服务版本进行路由</p><p>下面介绍一下一些配置</p><ul><li><p>目标主机<br>VirtualService中的目标主机定义使用hosts关键字。除了定义域名外，也可以直接定义可路由的服务</p><p><img src="/img/istio/826A6A8F-7A86-426A-957A-F46D3975C516.png" srcset="/img/loading.gif" lazyload alt="目标主机配置"></p></li><li><p>根据不同的版本对服务流量进行拆分<br>在Istio中服务版本依靠标签进行区分，可以定义不同种类的标签（如版本号、平台），对流量以不同的维度进行灵活的分配。拆分流量使用weight关键字来设置</p><p><img src="/img/istio/A6196787-6DC5-4160-81BC-13E431E25C2B.png" srcset="/img/loading.gif" lazyload alt="流量拆分"></p></li><li><p>subset（子集）关键字<br>subset其实就是特定版本的标签，它和标签的映射关系定义在DestinationRule里。比如在subset中设置标签为“version:v1”，代表只有附带这个标签的Pod才能接受流量。Istio强制要求Pod设置带有version的标签，以此来实现流量控制和指标收集等功能</p></li><li><p>timeout关键字设置请求的超时时间</p><p><img src="/img/istio/5D702153-3D34-4F5E-887C-95DCCD30C081.png" srcset="/img/loading.gif" lazyload alt="timeout关键字设置请求的超时时间"></p><p>访问ratings服务的请求设置10s超时</p></li><li><p>retries关键字设置重试</p><p><img src="/img/istio/5AA48379-D969-4479-AE99-CCA0B84071DE.png" srcset="/img/loading.gif" lazyload alt="retries关键字设置重试"></p><p>表示最多重试3次，每次的超时时间为2s</p></li><li><p>fault关键字来设置故障注入</p><p><img src="/img/istio/B8FAD230-AA64-4940-A943-E680B10D7F0B.png" srcset="/img/loading.gif" lazyload alt="fault关键字来设置故障注入"></p><p>注入了一个延迟故障，使得ratings服务10%的响应会出现5s的延迟。除了延迟，还可以设置终止或者返回HTTP故障码</p></li><li><p>通过match关键字定义匹配条件。</p><p><img src="/img/istio/4FF20965-52D8-4134-9204-4FA1AF75955F.png" srcset="/img/loading.gif" lazyload alt="通过match关键字定义匹配条件"></p><p>对特定的URL进行匹配<br>可以同时设置多个匹配项。匹配的策略有很多，比如头信息、标签等<br>如图</p><p><img src="/img/istio/78D21B51-361D-4FAD-9372-82A5DC5A925D.png" srcset="/img/loading.gif" lazyload alt="对特定的URL进行匹配"></p><p>VirtualService的路由配置规则有优先级。如果配置中定义了多条规则，则按照顺序优先匹配第一条，但是Header条件除外。如果匹配规则中设置了Header，则它具有最高优先级</p></li></ul><h2 id="DestinationRule"><a href="#DestinationRule" class="headerlink" title="DestinationRule"></a>DestinationRule</h2><p>DestinationRule通常都和VirtualService成对出现</p><p>主要功能<br>当VirtualService的路由生效后，配置一些策略并应用到请求中。</p><p>另外，subset和标签的对应关系也被定义在DestinationRule中</p><ul><li><p>DestinationRule的配置，除定义VirtualService中要用的两个subset外，还设置以随机的方式对reviews服务进行负载均衡</p><p><img src="/img/istio/CFFE16FE-82E7-42E6-9F8E-13A08589CFAA.png" srcset="/img/loading.gif" lazyload alt="DestinationRule的配置"></p></li><li><p>熔断（Circuit Breaker），一种服务降级处理的方式。当某个服务出现故障后，为了不影响下游服务而对其设置断流操作。可以在DestinationRule中实现这个功能</p></li></ul><p><img src="/img/istio/D10657FE-1FE8-45F7-8900-B83B7D20C36B.png" srcset="/img/loading.gif" lazyload alt="熔断"></p><p>对reviews服务的最大连接只能有100个，如果超过这个数字就会熔断</p><blockquote><p>如果特定的subset定义了策略，但没有定义对应的VirtualService，则该策略并不会执行。此时，Istio会以默认的方式（轮询）将请求发送给目标服务的全部版本。因此官方推荐方式是给每个服务都定义路由规则，避免这种情况发生</p></blockquote><h2 id="ServiceEntry"><a href="#ServiceEntry" class="headerlink" title="ServiceEntry"></a>ServiceEntry</h2><p>如果有需求让服务能够访问外部系统，就需要用到ServiceEntry。它也是一种配置资源，用来给服务网格内的服务提供访问外部URL的能力。<br>Istio中的服务发现功能主要是依靠服务注册表实现的，ServiceEntry能够在注册表中添加外部服务，使得内部服务可以访问这些被添加的URL。所以，通过ServiceEntry就可以实现访问外部服务的能力。<br>个人理解就是流量对外的网关</p><p><img src="/img/istio/3E1513EE-ED49-44F6-90F7-35F3CD99DBE7.png" srcset="/img/loading.gif" lazyload alt="ServiceEntry"></p><p>如图，配置一个外部的URL“*.foo.com”，使得网格内部的服务可以通过HTTP协议的80端口来访问它</p><h2 id="Gateway"><a href="#Gateway" class="headerlink" title="Gateway"></a>Gateway</h2><p>和ServiceEntry相反，外部请求想要访问网格内的服务就要用到Gateway。Gateway为进入网格的请求配置了一个负载均衡器，把VirtualService绑定到Gateway，这样就可以设置规则来控制进入的流量。<br>个人理解就是springcloud体系里的zuul和gateway，是个对内网关</p><p><img src="/img/istio/17ADD6E9-4C10-4D38-A6F9-36404547B65F.png" srcset="/img/loading.gif" lazyload alt="Gateway"></p><p>如图，为从外部进入Bookinfo网站的HTTPS流量配置了一个Gateway</p><p>要实现路由，还要定义一个VirtualService与网关绑定。</p><p><img src="/img/istio/3855240D-C58A-46A2-9205-5954CAA31056.png" srcset="/img/loading.gif" lazyload alt="VirtualService"></p><p>如图，在hosts中对之前定义的bookinfo-gateway的Gateway进行绑定</p><h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p>Istio中流量控制主要是由这4个配置资源共同协作完成。</p><ol><li>确认请求的主机（host）在VirtualService中是否有路由规则，</li><li>若有，则将请求发往对应的subset。</li><li>如果发现当前的subset在DestinationRule中定义了策略，则执行此策略。</li><li>同时，设置Gateway负责负载均衡以及为服务定义出口</li></ol><h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>Istio的流量管理功能主要是依靠Pilot组件和Envoy代理协作完成。</p><p>流量管理的规则配置由4个配置资源完成</p><ul><li>VirtualService定义路由规则</li><li>DestinationRule在路由生效后定义对于请求的策略</li><li>ServiceEntry提供了网格内服务访问外界服务的能力</li><li>Gateway让外部服务调用网格内服务</li></ul><h1 id="Mixer-1"><a href="#Mixer-1" class="headerlink" title="Mixer"></a>Mixer</h1><h2 id="功能-1"><a href="#功能-1" class="headerlink" title="功能"></a>功能</h2><ul><li>先决条件检查<br>可简单地理解为是对服务调用者的权限检查，比如调用者的身份验证是否正确、调用者是否在白名单里和是否达到了调用限制等</li><li>配额管理<br>允许服务在多个维度上分配和释放配额</li><li>遥测报告<br>生成日志记录、监控、追踪数据</li></ul><p>个人理解有点像zuul、zipkin的结合体</p><h2 id="如何实现功能？"><a href="#如何实现功能？" class="headerlink" title="如何实现功能？"></a>如何实现功能？</h2><p>Sidecar代理在每次发送请求时都会调用Mixer，此时Mixer可根据发送方的信息进行检查，确认它是否有权限进行下游服务的调用。<br>请求过后，Sidecar仍然会调用Mixer，将定义的遥测数据交给Mixer收集起来，Mixer再把收集到的数据交给后端接入的系统进行分析、监控。<br>这些由Sidecar发送给Mixer的数据被称作属性（Attribute），用来描述请求和与请求相关的环境或系统（如请求路径、目的服务和主机IP）</p><p>将收集的属性交给后端基础设施进行处理的流程图</p><p><img src="/img/istio/A8F8FAED-07F1-4044-819A-6CEA256E66AF.png" srcset="/img/loading.gif" lazyload alt="处理流程图"></p><h2 id="如何集成后端设施？"><a href="#如何集成后端设施？" class="headerlink" title="如何集成后端设施？"></a>如何集成后端设施？</h2><p>Mixer的一个重要特性: 配置模型。</p><p>配置模型基于以下两个部分</p><ul><li>适配器（Adapter）<br>后端设施的接口</li><li>模板（Template）<br>定义了属性和适配器输入的映射关系</li></ul><p>配置模型包括3种资源</p><ul><li>处理器（Handler）<br>用于确定正在使用的适配器及其操作方式</li><li>实例（Instance）<br>描述如何将请求属性映射到适配器输入，实例表示一个或多个适配器将操作的各种数据</li><li>规则（Rule）<br>定义了实例和处理器的映射关系，规则包含match表达式和action标签，match表达式控制何时调用适配器，而action决定了要提供给适配器的一组实例</li></ul><h2 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a>流程</h2><p><img src="/img/istio/54F893CE-75F5-42D8-B8D2-51DD69780A2B.png" srcset="/img/loading.gif" lazyload alt="流程"></p><ol><li>Envoy调用Mixer时，规则配置进行检查，确定调用哪个处理器，并将要处理的实例发送给处理器</li><li>处理器确定对应的后端适配器以及操作方式，将解析实例中的数据作为适配器的输入</li><li>适配器调用后端设施完成整个流程</li></ol><h1 id="Citadel-安全"><a href="#Citadel-安全" class="headerlink" title="Citadel(安全)"></a>Citadel(安全)</h1><p>Istio中的认证有两种</p><ul><li><p>传输认证（Transport Authentication）<br>也叫作服务到服务认证，验证直接客户端连接，提供双向TLS验证</p></li><li><p>身份认证（OriginAuthentication）<br>也叫作终端用户认证，验证终端用户或设备，比较常见的是通过JWT验证</p></li></ul><h2 id="TLS"><a href="#TLS" class="headerlink" title="TLS"></a>TLS</h2><p>TLS实现了将应用层的报文进行加密后再交由TCP进行传输的功能</p><p>该协议由两层组成</p><ol><li>TLS记录（TLS Record）协议</li><li>TLS握手（TLS Handshake）协议</li></ol><p>前身是SSL，即安全套接层（Secure Sockets Layer）</p><p>所谓的双向TLS（mutual TLS，mTLS）认证，是客户端和服务端都需要彼此进行验证</p><p>在Istio中，客户端和服务端的Envoy会建立一个双向TLS连接，由代理完成验证，授权后再转发到服务本身。它还提供了一个宽容模式的mTLS，即同时允许纯文本流量和加密流量验证。这个功能使得Istio的安全架构具有了极大的兼容性</p><h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><p>JWT是一种基于客户端的解决方案</p><p>工作原理</p><p>用户登录后服务器生成一个令牌给客户端，由客户端保存；发送请求时带着令牌，服务器根据签名规则验证令牌的合法性和身份。一个完整的JWT包括3个部分：头部（Header）、负载（Payload）和签名（Signature）。头部负责定义JWT的元数据，负载存放实际需要传递的信息，签名是通过签名算法对前两部分进行编码而生成的字符串，可防止数据被篡改。这3部分组成一个Token，中间用点隔开，下图为示例</p><p><img src="/img/istio/2F113C67-23AB-40C8-80B3-3CFA9D3A2967.png" srcset="/img/loading.gif" lazyload alt="工作原理"></p><p>使用的时候通常都被添加在请求头里，设置如下<br><img src="/img/istio/1C7120FD-3B5D-4FA6-B2F4-C0C6865249AA.png" srcset="/img/loading.gif" lazyload alt="添加在请求头"></p><p>Istio的身份认证目前只支持JWT授权方式</p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol><li><p><a target="_blank" rel="noopener" href="https://github.com/CNCF123/Document/tree/master/Istio/huaweicloud/pdf">华为云Istio入门教程</a></p></li><li><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1vt411H755?from=search&seid=9658571065723447167">Istio教程</a></p></li></ol><h1 id="推荐书单"><a href="#推荐书单" class="headerlink" title="推荐书单"></a><a href="/Istio">推荐书单</a></h1></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a> <a class="hover-with-bg" href="/tags/Istio/">Istio</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/posts/368864908.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">线程</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"></article></div></div><article class="comments" id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://fastly.jsdelivr.net/npm/valine@1/dist/Valine.min.js",(function(){var i=Object.assign({appId:"AotNUTqXh4KxbyAqtWFR9PH6-gzGzoHsz",appKey:"cqckpd2YjhM5GWX2Ew4tKNyY",path:"window.location.pathname",placeholder:"说点什么吧...",avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!1,recordIP:!0,serverURLs:"",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{Fluid.plugins.initFancyBox("#valine .vcontent img:not(.vemoji)")})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><div style="font-size:.85rem"><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="/js/duration.js"></script></div></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">沪ICP备2022013557号-1</a></span></div></footer><script src="https://fastly.jsdelivr.net/npm/nprogress@0/nprogress.min.js"></script><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/nprogress@0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://fastly.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="https://fastly.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/local-search.js"></script><script src="/js/img-lazyload.js"></script><script src="https://fastly.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js"></script><script src="https://fastly.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="https://fastly.jsdelivr.net/npm/anchor-js@4/anchor.min.js"></script><script defer src="https://fastly.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?29d28856048f5cb020dac5f5c6add7a9";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script src="https://fastly.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://fastly.jsdelivr.net/npm/meting@1.2.0/dist/Meting.min.js"></script><script src="/js/boot.js"></script><script src="/js/backgroundize.js"></script><link defer rel="stylesheet" href="/css/backgroundize.css"><script src="/js/timevalid.js"></script><script src="/js/reward.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"right","width":120,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body></html>