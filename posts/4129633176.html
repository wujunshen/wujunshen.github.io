<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/icon/cat.png"><link rel="icon" href="/img/icon/cat.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="咖啡猫"><meta name="keywords" content=""><meta name="description" content="框架介绍"><meta property="og:type" content="article"><meta property="og:title" content="Dubbo"><meta property="og:url" content="https://www.wujunshen.cn/posts/4129633176.html"><meta property="og:site_name" content="咖啡猫"><meta property="og:description" content="框架介绍"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.wujunshen.cn/img/jetbrain/1920x1080-pycharm2022_1.png"><meta property="article:published_time" content="2022-05-17T03:05:09.000Z"><meta property="article:modified_time" content="2022-05-30T12:21:36.000Z"><meta property="article:author" content="咖啡猫"><meta property="article:tag" content="框架"><meta property="article:tag" content="Dubbo"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://www.wujunshen.cn/img/jetbrain/1920x1080-pycharm2022_1.png"><title>Dubbo - 咖啡猫</title><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/hint.css@2/hint.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prismjs@1/plugins/line-numbers/prism-line-numbers.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"www.wujunshen.cn",root:"/",version:"1.8.14",typing:{enable:!1,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,baidu:"29d28856048f5cb020dac5f5c6add7a9",google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:"https://aotnutqx.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!0,appId:"AotNUTqXh4KxbyAqtWFR9PH6-gzGzoHsz",appKey:"cqckpd2YjhM5GWX2Ew4tKNyY",counter:{enable:!0},visitor:{enable:!0},like:{enable:!0}}},search_path:"/local-search.xml"}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script src="/js/statistics.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>咖啡猫</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> 图书馆</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/ElasticSearch/">ElasticSearch </a><a class="dropdown-item" href="/Kafka/">Kafka </a><a class="dropdown-item" href="/RabbitMQ/">RabbitMQ </a><a class="dropdown-item" href="/Zookeeper/">Zookeeper </a><a class="dropdown-item" href="/Redis/">Redis </a><a class="dropdown-item" href="/mysql/">Mysql </a><a class="dropdown-item" href="/Dubbo/">Dubbo </a><a class="dropdown-item" href="/%E5%8D%8F%E8%AE%AE/">协议 </a><a class="dropdown-item" href="/Socket/">Socket </a><a class="dropdown-item" href="/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/">函数式编程 </a><a class="dropdown-item" href="/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式 </a><a class="dropdown-item" href="/Istio/">Istio </a><a class="dropdown-item" href="/algorithm/">算法</a></div></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/page/post.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="Dubbo">Dubbo</span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> 咖啡猫 </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-05-17 11:05" pubdate>星期二, 五月 17日 2022, 11:05 上午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 4.9k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 41 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">Dubbo</h1><p class="note note-info">本文最后更新于：星期一, 五月 30日 2022, 8:21 晚上</p><div class="markdown-body"><h1 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h1><h2 id="10层模型"><a href="#10层模型" class="headerlink" title="10层模型"></a>10层模型</h2><ol><li>service接口层: 给服务提供者和消费者实现</li><li>config配置层: 对 dubbo 进行各种配置</li><li>proxy服务代理层: 无论是服务提供者还是消费者，dubbo 都会生成代理，代理之间进行网络通信</li><li>registry服务注册层: 负责服务注册与发现</li><li>cluster集群层: 封装多个服务提供者的路由以及负载均衡，将多个实例组合成一个服务</li><li>monitor监控层: 对 rpc 接口的调用次数和调用时间进行监控</li><li>protocal远程调用层: 封装 rpc 调用</li><li>exchange信息交换层: 封装请求响应模式，同步转异步</li><li>transport网络传输层: 抽象 mina 和 netty 为统一接口</li><li>serialize数据序列化层: 可复用的一些序列化和反序列化工具，支持5种方式（fastjson、Hessian2、Kryo、fst 及 Java原生支持）。也可扩展自定义的序列化和反序列化工具</li></ol><p><img src="/img/dubbo/2A4D159B-9474-499A-9552-D22CADEBD9D0.png" srcset="/img/loading.gif" lazyload alt="10层模型"></p><h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><ol><li><p>provider向注册中心去注册</p></li><li><p>consumer从注册中心订阅服务</p></li><li><p>注册中心会通知consumer注册好的服务</p></li><li><p>consumer调用provider</p></li><li><p>consumer和provider每隔一段时间，都把各自的统计数据异步通知给监控中心</p><p><img src="/img/dubbo/4EC104FF-0A47-44D7-9000-5945490C3FEE.png" srcset="/img/loading.gif" lazyload alt="流程"></p></li></ol><blockquote><p>注册中心挂了可以继续通信吗？<br>可以，因为初始化时候，消费者会将提供者的地址等元数据信息拉取到本地缓存，所以注册中心挂了还可以继续通信</p></blockquote><p>dubbo10层每个层都有可以考核的面试知识点，以下按照我个人分析一一罗列出来</p><h2 id="dubbo负载均衡策略"><a href="#dubbo负载均衡策略" class="headerlink" title="dubbo负载均衡策略"></a>dubbo负载均衡策略</h2><ul><li><p>random loadbalance<br><code>dubbo</code>默认负载均衡策略是<code>random loadbalance</code>，即随机调用实现负载均衡，可对<code>provider</code>不同实例设置不同的权重，会按照权重来负载均衡，权重越大分配流量越高，一般默认这个就行</p></li><li><p>round robin loadbalance<br>这个负载均衡策略默认均匀地将流量打到各个服务器节点上，但如果各个服务器性能不一样，容易导致性能差的服务器负载过高。所以需要调整权重，让性能差的服务器承载权重小一些，流量少一些</p></li><li><p>least active loadbalance<br>自动感知，服务器性能越差，那么接收的请求越少，越不活跃，此时就会给不活跃，性能差的服务器更少的请求</p></li><li><p>consistant hash loadbalance<br>一致性<code>Hash</code>算法,相同参数的请求一定分发到同一个<code>provider</code>上,<code>provider</code>挂掉时,会基于虚拟节点均匀分配剩余的流量，抖动不会太大。如果需要的不是随机负载均衡，而是要同一类请求都到一个节点，那就使用这个一致性<code>Hash</code>策略</p></li></ul><h2 id="dubbo集群容错策略"><a href="#dubbo集群容错策略" class="headerlink" title="dubbo集群容错策略"></a>dubbo集群容错策略</h2><ul><li>failover cluster模式<br><code>dubbo</code>默认集群容错策略，请求失败就自动切换，自动重试其他服务器，常见于读操作。（失败重试其它机器）<br>可通过以下几种方式配置重试次数</li></ul><div class="code-wrapper"><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>service</span> <span class="token attr-name">retries</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><div class="code-wrapper"><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">retries</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><div class="code-wrapper"><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>findFoo<span class="token punctuation">"</span></span> <span class="token attr-name">retries</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">dubbo:</span>reference</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div><ul><li>failfast cluster模式<br>一次调用失败就立即失败，常见于非幂等性的写操作，比如新增一条记录（调用失败就立即失败）</li><li>failsafe cluster模式<br>出现异常时忽略掉，常用于不重要的接口调用，比如记录日志<br>配置示例如下</li></ul><div class="code-wrapper"><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>service</span> <span class="token attr-name">cluster</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>failsafe<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><div class="code-wrapper"><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">cluster</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>failsafe<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><ul><li>failback cluster模式<br>失败了后台自动记录请求，然后定时重发，比较适合于写消息队列这种</li><li>forking cluster模式<br>并行调用多个<code>provider</code>，只要一个成功就立即返回。常用于实时性要求比较高的读操作，但会浪费更多的服务资源，可通过<code>forks=&quot;2&quot;</code>来设置最大并行数</li><li>broadcacst cluster<br>逐个调用所有的<code>provider</code>。任何一个<code>provider</code>出错则报错。通常用于通知所有提供者更新缓存或日志等本地资源信息</li></ul><h2 id="dubbo动态代理策略"><a href="#dubbo动态代理策略" class="headerlink" title="dubbo动态代理策略"></a>dubbo动态代理策略</h2><p>默认使用<code>javassist</code>动态字节码生成，创建代理类。但可通过<code>spi</code>扩展机制配置自己的动态代理策略</p><h2 id="SPI（Service-Provider-Interface）"><a href="#SPI（Service-Provider-Interface）" class="headerlink" title="SPI（Service Provider Interface）"></a>SPI（Service Provider Interface）</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>根据<strong>指定的配置</strong>或者<strong>默认的配置</strong>，找到对应的实现类并加载进系统，之后就可以用这个实现类的实例对象</p><p>举例:<br>有一个接口A。A1&#x2F;A2&#x2F;A3分别是接口A的不同实现。通过配置接口A&#x3D;实现A2，那在系统实际运行时，会加载配置，用实现A2实例化一个对象来提供服务</p><p>spi使用场景？<strong>插件扩展</strong>场景，比如开发了一个给别人使用的开源框架，如果想让别人自己写个插件，插到你的开源框架里面，从而扩展某个功能，这个时候spi就有用武之地</p><h3 id="Java中SPI使用"><a href="#Java中SPI使用" class="headerlink" title="Java中SPI使用"></a>Java中SPI使用</h3><ul><li>jdbc<br>java定义了一套jdbc接口，但Java并没提供jdbc的实现类<br>但实际项目运行时，要使用jdbc接口的哪些实现类呢？一般来说，我们要根据自己使用的数据库，比如<code>mysql</code>，将<code>mysql-jdbc-connector.jar</code>引入进来；<code>oracle</code>，就将<code>oracle-jdbc-connector.jar</code>引入进来<br>在系统运行时，碰到使用jdbc的接口，spi会在底层使用引入的那个jar中提供的实现类</li></ul><h3 id="Dubbo中SPI使用"><a href="#Dubbo中SPI使用" class="headerlink" title="Dubbo中SPI使用"></a>Dubbo中SPI使用</h3><p>dubbo也用了spi，不过没有用java的spi机制，而是自己实现了一套spi机制</p><p>举例</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Protocol</span> protocol <span class="token operator">=</span> <span class="token class-name">ExtensionLoader</span><span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span><span class="token class-name">Protocol</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p>对于这个<code>Protocol</code>接口，<code>dubbo</code>在系统运行时会判断一下应该选用这个<code>Protocol</code>接口的哪个实现类来实例化对象。需要配置文件配置一个<code>Protocol</code>实现类，加载到<code>jvm</code>，然后实例化对象，用这个<code>Protocol</code>实现类就行</p><p>在<code>dubbo</code>里<code>SPI</code>被大量使用，对很多组件都会保留一个接口和多个实现，然后在系统运行时，动态根据配置去找到对应的实现类。如果没配置，就走默认实现</p><p>在dubbo源码中，在<code>/META_INF/dubbo/internal/com.alibaba.dubbo.rpc.Protocol</code>下对<code>Protocol</code>接口做了配置</p><div class="code-wrapper"><pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token key attr-name">dubbo</span><span class="token punctuation">=</span><span class="token value attr-value">com.alibaba.dubbo.rpc.protocol.dubbo.DubboProtocol</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p>如上，将<code>dubbo</code>作为默认key去配置文件里找，配置文件名称与接口全限定名一样，通过<code>dubbo</code>作为key找到默认的实现类<code>com.alibaba.dubbo.rpc.protocol.dubbo.DubboProtocol</code></p><h4 id="自定义扩展dubbo组件的方法"><a href="#自定义扩展dubbo组件的方法" class="headerlink" title="自定义扩展dubbo组件的方法"></a>自定义扩展dubbo组件的方法</h4><p><img src="/img/dubbo/F4598D6B-0547-4618-9C5B-7536AB955CA4.png" srcset="/img/loading.gif" lazyload alt="自定义扩展dubbo组件方法"></p><ol><li><p>把自定义扩展的组件写完代码，打成<code>jar</code>包，在里面的<code>src/main/resources</code>目录下，新建<code>META-INF/services</code>目录，增加文件: <code>com.alibaba.dubbo.rpc.Protocol</code>，文件内容为<code>my=com.bingo.MyProtocol</code>。然后把<code>jar</code>安装到<code>nexus</code>私服</p></li><li><p>新建<code>dubbo provider</code>工程，在工程里面依赖自定义的组件包<code>jar</code>，然后在<code>spring</code>配置文件里配置</p><div class="code-wrapper"><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>protocol</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>”my”</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span>”20000”</span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></li><li><p><code>provider</code>启动时，就会加载<code>jar</code>包里的<code>my=com.bingo.MyProtocol</code>这行配置，接着会根据配置使用自定义好的<code>MyProtocol</code></p></li></ol><p>通过上述方式，就可替换掉大量的<code>dubbo</code>内部的组件</p><h2 id="dubbo服务治理"><a href="#dubbo服务治理" class="headerlink" title="dubbo服务治理"></a>dubbo服务治理</h2><h3 id="服务链式追踪监控"><a href="#服务链式追踪监控" class="headerlink" title="服务链式追踪监控"></a>服务链式追踪监控</h3><p>基于<code>dubbo</code>做的分布式系统，自动记录各个服务之间的互相调用情况，然后自动将服务之间的依赖关系和调用链路生成出来。老实说，这一点<code>dubbo</code>原生做的不好，建议使用<code>skywalking</code>这种apm类型来监控</p><h3 id="服务访问压力以及时长统计"><a href="#服务访问压力以及时长统计" class="headerlink" title="服务访问压力以及时长统计"></a>服务访问压力以及时长统计</h3><p>自动统计各个接口和服务之间的<strong>调用次数</strong>以及<strong>访问延时</strong></p><p>两个级别</p><ul><li>接口粒度<br>每个服务的每个接口每天被调用多少次，<code>TP50/TP90/TP99</code>，三个档次的请求延时分别是多少</li><li>从调用源头开始<br>一个完整的请求链路经过几十个服务之后，完成一次请求，每天全链路走多少次，全链路请求延时的<code>TP50/TP90/TP99</code>，分别是多少</li></ul><h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><ul><li>服务分层（避免循环依赖）</li><li>调用链路失败监控和报警</li><li>服务鉴权</li><li>每个服务的可用性的监控（接口调用成功率？几个9？<code>SLA</code>，这个在<code>SkyWalking</code>中已经可以实现）</li></ul><h2 id="dubbo服务降级"><a href="#dubbo服务降级" class="headerlink" title="dubbo服务降级"></a>dubbo服务降级</h2><p>配置文件举例</p><div class="code-wrapper"><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fooService<span class="token punctuation">"</span></span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.test.service.FooService<span class="token punctuation">"</span></span>  <span class="token attr-name">timeout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10000<span class="token punctuation">"</span></span> <span class="token attr-name">check</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">mock</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>return null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div><p>调用接口失败时，可通过mock统一返回null<br>mock值也可修改为true，然后再接口同一个路径下实现一个Mock类，命名规则是“接口名称+Mock”后缀。在Mock类里实现自己的降级逻辑<br>代码示例</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloServiceMock</span> <span class="token keyword">implements</span> <span class="token class-name">HelloService</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 降级逻辑</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><h2 id="dubbo失败重试和超时重试"><a href="#dubbo失败重试和超时重试" class="headerlink" title="dubbo失败重试和超时重试"></a>dubbo失败重试和超时重试</h2><p>在配置文件中配置</p><ul><li>timeout<br>一般设置为200ms，个人认为不能超过200ms还没返回</li><li>retries<br>设置retries，一般在读请求时，比如要查询数据，设置个retries，如果第一次没读到，报错，重试指定的次数，尝试再次读取<br>举例如下<div class="code-wrapper"><pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">dubbo:</span>reference</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>xxxx<span class="token punctuation">"</span></span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>xx<span class="token punctuation">"</span></span> <span class="token attr-name">check</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">async</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">retries</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span> <span class="token attr-name">timeout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2000<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div>配置<code>timeout=“2000”</code>，意思就是等待2s后，要是还没返回，就撤了，不干等结果。</li></ul><h2 id="dubbo通信协议"><a href="#dubbo通信协议" class="headerlink" title="dubbo通信协议"></a>dubbo通信协议</h2><h3 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h3><ul><li>序列化<br>把数据结构或对象转换为二进制串的过程</li><li>反序列化<br>在序列化过程中所生成的二进制串转换成数据结构或者对象的过程</li></ul><p><img src="/img/dubbo/477EE8CB-C8B6-4349-80E2-A7F4B594506A.png" srcset="/img/loading.gif" lazyload alt="反序列化"></p><h3 id="dubbo支持不同的通信协议"><a href="#dubbo支持不同的通信协议" class="headerlink" title="dubbo支持不同的通信协议"></a>dubbo支持不同的通信协议</h3><ul><li><p>dubbo协议<br>默认协议，单一长连接，进行的是NIO异步通信，基于hessian作为序列化协议。使用的场景：传输数据量小（每次请求在100kb以内），但并发量高的场景。<br>为了支持高并发场景，一般做法就是服务提供者只有几个服务器节点，但是服务消费者有上百个服务器节点，可能每天调用量就达到上亿次！此时用长连接是最合适的，只要跟每个服务消费者维持一个长连接就行，总共就100个左右连接。然后后面基于长连接NIO异步通信，支撑高并发请求长连接，简单说就是建立连接后可以持续发送请求，无须再建立连接<br><img src="/img/dubbo/C5B04C1C-0A39-48DE-9FAD-BB718A5CBF4C.png" srcset="/img/loading.gif" lazyload alt="长连接"><br>短连接就是每次要发送请求之前，需要先重新建立一次连接<br><img src="/img/dubbo/9EFF8818-80CA-4B4D-83FF-B0B8C2262074.png" srcset="/img/loading.gif" lazyload alt="短连接"></p></li><li><p>rmi 协议<br>Java 二进制序列化，多个短连接，适合消费者和提供者数量差不多的情况，适用于文件的传输，一般较少用</p></li><li><p>hessian 协议<br>hessian 序列化协议，多个短连接，适用于提供者数量比消费者数量还多的情况，适用于文件的传输，一般较少用</p></li><li><p>http 协议<br>json 序列化</p></li><li><p>webservice<br>SOAP 文本序列化</p></li></ul><h2 id="dubbo序列化协议"><a href="#dubbo序列化协议" class="headerlink" title="dubbo序列化协议"></a>dubbo序列化协议</h2><p><code>dubbo</code>支持<code>hession</code>、<code>Java</code>二进制序列化、<code>json</code>、<code>SOAP</code>文本序列化多种序列化协议</p><p><code>hessian</code>是其默认的序列化协议</p><p>现在还会有个<code>Protocol Buffer</code>数据存储格式，是Google出品的一种轻量且高效的结构化数据存储格式，性能比<code>JSON</code>、<code>XML</code>要高很多</p><p>性能高的原因有两个</p><ol><li>使用<code>proto</code>编译器，自动进行序列化和反序列化，速度非常快，应该比<code>XML</code>和<code>JSON</code>快上20~100倍</li><li>数据压缩效果好，它序列化后的数据量体积小。因为体积小，传输起来带宽和速度上会有优化</li></ol><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol><li><a target="_blank" rel="noopener" href="https://gitee.com/shishan100/Java-Interview-Advanced">中华石杉–互联网Java进阶面试训练营</a></li></ol><h1 id="推荐书单"><a href="#推荐书单" class="headerlink" title="推荐书单"></a><a href="/Dubbo">推荐书单</a></h1></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E6%A1%86%E6%9E%B6/">框架</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/%E6%A1%86%E6%9E%B6/">框架</a> <a class="hover-with-bg" href="/tags/Dubbo/">Dubbo</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/posts/4266433718.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">volatile</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/posts/987247817.html"><span class="hidden-mobile">Zookeeper</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://fastly.jsdelivr.net/npm/valine@1/dist/Valine.min.js",(function(){var i=Object.assign({appId:"AotNUTqXh4KxbyAqtWFR9PH6-gzGzoHsz",appKey:"cqckpd2YjhM5GWX2Ew4tKNyY",path:"window.location.pathname",placeholder:"说点什么吧...",avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!1,recordIP:!0,serverURLs:"",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{Fluid.plugins.initFancyBox("#valine .vcontent img:not(.vemoji)")})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><div style="font-size:.85rem"><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="/js/duration.js"></script></div></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">沪ICP备2022013557号-1</a></span></div></footer><script src="https://fastly.jsdelivr.net/npm/nprogress@0/nprogress.min.js"></script><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/nprogress@0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://fastly.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="https://fastly.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/local-search.js"></script><script src="/js/img-lazyload.js"></script><script src="https://fastly.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js"></script><script src="https://fastly.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="https://fastly.jsdelivr.net/npm/anchor-js@4/anchor.min.js"></script><script defer src="https://fastly.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?29d28856048f5cb020dac5f5c6add7a9";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script src="https://fastly.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://fastly.jsdelivr.net/npm/meting@1.2.0/dist/Meting.min.js"></script><script src="/js/boot.js"></script><script src="/js/backgroundize.js"></script><link defer rel="stylesheet" href="/css/backgroundize.css"><script src="/js/timevalid.js"></script><script src="/js/reward.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"right","width":120,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body></html>