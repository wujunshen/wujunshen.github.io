<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/icon/cat.png"><link rel="icon" href="/img/icon/cat.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="咖啡猫"><meta name="keywords" content=""><meta name="description" content="数据结构-Map-ConcurrentHashMap"><meta property="og:type" content="article"><meta property="og:title" content="ConcurrentHashMap"><meta property="og:url" content="https://www.wujunshen.cn/posts/3455415529.html"><meta property="og:site_name" content="咖啡猫"><meta property="og:description" content="数据结构-Map-ConcurrentHashMap"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.wujunshen.cn/img/jetbrain/1920x1080-youtrack2022_1.png"><meta property="article:published_time" content="2022-05-27T13:39:13.000Z"><meta property="article:modified_time" content="2022-05-30T12:33:14.000Z"><meta property="article:author" content="咖啡猫"><meta property="article:tag" content="算法"><meta property="article:tag" content="数据结构"><meta property="article:tag" content="Map"><meta property="article:tag" content="ConcurrentHashMap"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://www.wujunshen.cn/img/jetbrain/1920x1080-youtrack2022_1.png"><title>ConcurrentHashMap - 咖啡猫</title><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/hint.css@2/hint.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prismjs@1/plugins/line-numbers/prism-line-numbers.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"www.wujunshen.cn",root:"/",version:"1.8.14",typing:{enable:!1,typeSpeed:70,cursorChar:"_",loop:!1},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"right",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},copy_btn:!0,image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,baidu:"29d28856048f5cb020dac5f5c6add7a9",google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:"https://aotnutqx.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!0,appId:"AotNUTqXh4KxbyAqtWFR9PH6-gzGzoHsz",appKey:"cqckpd2YjhM5GWX2Ew4tKNyY",counter:{enable:!0},visitor:{enable:!0},like:{enable:!0}}},search_path:"/local-search.xml"}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script src="/js/statistics.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><div id="web_bg"></div><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>咖啡猫</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> 图书馆</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/ElasticSearch/">ElasticSearch </a><a class="dropdown-item" href="/Kafka/">Kafka </a><a class="dropdown-item" href="/RabbitMQ/">RabbitMQ </a><a class="dropdown-item" href="/Zookeeper/">Zookeeper </a><a class="dropdown-item" href="/Redis/">Redis </a><a class="dropdown-item" href="/mysql/">Mysql </a><a class="dropdown-item" href="/Dubbo/">Dubbo </a><a class="dropdown-item" href="/%E5%8D%8F%E8%AE%AE/">协议 </a><a class="dropdown-item" href="/Socket/">Socket </a><a class="dropdown-item" href="/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/">函数式编程 </a><a class="dropdown-item" href="/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式 </a><a class="dropdown-item" href="/Istio/">Istio </a><a class="dropdown-item" href="/algorithm/">算法</a></div></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div class="banner" id="banner" parallax="true" style="background:url(/img/page/post.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="page-header text-center fade-in-up"><span class="h2" id="subtitle" title="ConcurrentHashMap">ConcurrentHashMap</span><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> 咖啡猫 </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-05-27 21:39" pubdate>星期五, 五月 27日 2022, 9:39 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 13k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 109 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div class="py-5" id="board"><article class="post-content mx-auto"><h1 style="display:none">ConcurrentHashMap</h1><p class="note note-info">本文最后更新于：星期一, 五月 30日 2022, 8:33 晚上</p><div class="markdown-body"><h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>java5开始才有的并发类，可以高效地支持并发操作。基本上就是个线程安全版的HashMap。但是key和value都不能为null，这点和HashMap不同</p><h1 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h1><h2 id="java8之前"><a href="#java8之前" class="headerlink" title="java8之前"></a>java8之前</h2><p>Segment数组+HashEntry数组+链表结构</p><p>它由一个个Segment组成，Segment就是我们说的分段锁，一个HashEntry数组对应一个分段锁</p><p>简单说，ConcurrentHashMap就是一个Segment数组，Segment通过继承ReentrantLock来加锁，每次需要加锁的操作，锁住的是一个Segment，这样只要保证每个Segment线程都安全，也就保证了全局是线程安全的</p><p>如下图<br><img src="/img/ConcurrentHashMap/D3A76B10-9779-41EE-8885-F67562F9BA78.png" srcset="/img/loading.gif" lazyload alt="保证每个Segment线程安全"></p><blockquote><p>初始化后Segment数组是无法扩容的，能扩容的只有HashEntry数组。如果初始化时候，没有指定segment数组长度，默认为16。如果指定长度，则使用指定长度</p></blockquote><p>基本属性源码</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * 段掩码，用于定位段，默认值15，不可变
 */</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> segmentMask<span class="token punctuation">;</span>

<span class="token comment">/**
 * 段偏移量，用于定位段，默认值28，不可变
 */</span>
<span class="token keyword">final</span> <span class="token keyword">int</span> segmentShift<span class="token punctuation">;</span>

<span class="token comment">/**
 * 段数组
 */</span>
<span class="token keyword">final</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> segments<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">ReentrantLock</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 真正存储数据的数组
     */</span>
    <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 用于统计当前Segement大小，即HashEntry数组长度
     */</span>
    <span class="token keyword">transient</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 记录结构性修改次数，用于快速失败
     */</span>
    <span class="token keyword">transient</span> <span class="token keyword">int</span> modCount<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 阈值
     */</span>
    <span class="token keyword">transient</span> <span class="token keyword">int</span> threshold<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 负载因子，默认 0.75
     */</span>
    <span class="token keyword">final</span> <span class="token keyword">float</span> loadFactor<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//节点hash值</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> hash<span class="token punctuation">;</span>
    <span class="token comment">//节点key值</span>
    <span class="token keyword">final</span> <span class="token class-name">K</span> key<span class="token punctuation">;</span>
    <span class="token comment">//节点value值</span>
    <span class="token keyword">volatile</span> <span class="token class-name">V</span> value<span class="token punctuation">;</span>
    <span class="token comment">//下个节点引用</span>
    <span class="token keyword">volatile</span> <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> next<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>从以上代码可知，一个<code>Segment</code>就是一个<code>HashMap</code>，多个<code>HashMap</code>组成一个<code>ConcurrentHashMap</code>。<code>segmentMask</code>和<code>segmentShift</code>组合起来用于定位Segment数组的下标位置</p><p>由于目前java已发展到14版本，因此对于<code>java8</code>之前的版本，<code>ConcurrentHashMap</code>操作只做文字说明，有兴趣的可自行查看java7等8之前的版本源码</p><h3 id="put操作"><a href="#put操作" class="headerlink" title="put操作"></a>put操作</h3><ol><li>计算待put数据key的hash值</li><li>根据hash值、segmentShift和segmentMask通过无符号右移运算和位运算定位到哪个Segment，一个 Segment对应一个HashEntry数组</li><li>尝试获取锁，如果获取失败则自旋获取锁</li><li>根据hash值通过位运算得到HashEntry数组的下标，即得到链表的头节点，然后遍历链表</li><li>如果链表不为空，判断传入的key和hash值与当前遍历的key和hash值是否相等，相等则覆盖旧的value</li><li>如果链表为空（即表头为空），则根据待put数据的key和value创建结点，即初始化链表</li><li>判断元素个数是否超过阈值，数组长度大于阈值threshold且小于最大容量，则进行rehash扩容</li><li>如果不需扩容，则把新节点放到HashEntry数组中对应的位置（即把新的节点设置成原链表的表头，头插法）</li><li>最后释放锁</li></ol><h3 id="get操作"><a href="#get操作" class="headerlink" title="get操作"></a>get操作</h3><ol><li>计算get数据key的hash值</li><li>根据hash值、segmentShift和segmentMask通过无符号右移运算和位运算定位到哪个Segment，一个 Segment对应一个HashEntry数组</li><li>根据hash值通过位运算得到HashEntry数组下标，即得到链表的头节点，然后遍历链表</li><li>判断传入的key和hash值与当前遍历的key和hash值是否相等，相等则返回对应value，否则返回null</li></ol><h3 id="扩容操作"><a href="#扩容操作" class="headerlink" title="扩容操作"></a>扩容操作</h3><ol><li>创建新HashEntry数组，数组长度是原来的2倍，重新计算新的阈值</li><li>遍历旧数组，把每个元素（即HashEntry链表）迁移到新数组里面，步骤如下</li><li>如果旧数组只有一个结点，则直接放入新数组中</li><li>如果链表有多个结点，遍历旧链表，计算存放在新数组中的位置，使用头插法插入到新数组，即旧链表的表头结点做为新链表的尾结点</li><li>迁移完成之后将待新增数据插入链表的头部（头插法），最后将新数组的引用替换旧的</li></ol><h2 id="从java8开始及之后版本"><a href="#从java8开始及之后版本" class="headerlink" title="从java8开始及之后版本"></a>从java8开始及之后版本</h2><p>几个变化</p><ol><li>使用Node数组作为数据的基本存储。但锁粒度被缩小到数组中的每个下标位置上，数据读取的可见性依靠volatile来保证。尝试写入时，会将对应的下标位置上的元素作为加锁对象，使用synchronized进行加锁，来保证并发写入的安全性</li><li>如果多个Key的hashcode在取模后落在了相同的下标位置上，且在一定数量内（默认是8），采用链表方式连接节点；超过之后，为提高查询效率，会转为红黑树结构进行存储（和HashMap一样树化成红黑树）</li><li>当进行扩容时，除了扩容线程本身，如果其他线程识别到扩容正在进行中，则会尝试协助扩容</li></ol><h3 id="和java8之后的HashMap相同点"><a href="#和java8之后的HashMap相同点" class="headerlink" title="和java8之后的HashMap相同点"></a>和java8之后的HashMap相同点</h3><ul><li>底层数据结构一致（数组+链表+红黑树）</li><li>数组初始化都是在第一次put元素时进行，而不是new对象时候</li><li>数组长度都总是为2的幂</li><li>默认树化的阈值为8，而退化为链表的阈值为6</li><li>hash算法也很类似，ConcurrentHashMap也是key的hashCode值右移16位和原值取异或。但多了一步，和HASH_BITS取与，这是是为了消除最高位上的负符号，hash的负值在ConcurrentHashMap中有特殊意义表示在扩容或者是树节点(下文都会提及)</li></ul><p>下面从源码角度说明几个操作(java11版本)</p><h3 id="put操作-1"><a href="#put操作-1" class="headerlink" title="put操作"></a>put操作</h3><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> TREEIFY_THRESHOLD <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">putVal</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/** Implementation for put and putIfAbsent */</span>
<span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1.使用spread方法得到key的hash</span>
    <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">spread</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> f<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">,</span> fh<span class="token punctuation">;</span> <span class="token class-name">K</span> fk<span class="token punctuation">;</span> <span class="token class-name">V</span> fv<span class="token punctuation">;</span>
        <span class="token comment">//2.第一次调用put时才调用initTable方法来初始化Node数组</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            tab <span class="token operator">=</span> <span class="token function">initTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.如果相应位置的Node节点还未初始化，则通过CAS插入相应的数据</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">casTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// no lock when adding to empty bin</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//4.如果对应Node不为空，且其hash标识为特定负数，也就是标识容器正在扩容的负数，此时需协助扩容</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fh <span class="token operator">=</span> f<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> MOVED<span class="token punctuation">)</span>
            tab <span class="token operator">=</span> <span class="token function">helpTransfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>onlyIfAbsent <span class="token comment">// check first node without acquiring lock</span>
                 <span class="token operator">&amp;&amp;</span> fh <span class="token operator">==</span> hash
                 <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fk <span class="token operator">=</span> f<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>fk <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>fk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                 <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>fv <span class="token operator">=</span> f<span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> fv<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">V</span> oldVal <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">//5.执行元素添加</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">//5.1该节点的hash不小于0，则遍历链表更新节点或插入新节点</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>fh <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        binCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e <span class="token operator">=</span> f<span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            <span class="token class-name">K</span> ek<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>
                                <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span>
                                 <span class="token punctuation">(</span>ek <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                oldVal <span class="token operator">=</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span>
                                    e<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> pred <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                                pred<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">&#125;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token comment">//5.2如果是TreeBin类型节点，说明是红黑树，则通过putTreeVal方法往红黑树中插入节点</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token keyword">instanceof</span> <span class="token class-name">TreeBin</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> p<span class="token punctuation">;</span>
                        binCount <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeBin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">)</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span>
                                                       value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                            oldVal <span class="token operator">=</span> p<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span>
                                p<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
                    <span class="token punctuation">&#125;</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token keyword">instanceof</span> <span class="token class-name">ReservationNode</span><span class="token punctuation">)</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Recursive update"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">//6.采用链表存储节点，且链表长度超过阀值，则将链表转化为红黑树(树化)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">>=</span> TREEIFY_THRESHOLD<span class="token punctuation">)</span>
                    <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVal <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> oldVal<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//7.容器内元素总数+1，并在需要时执行扩容</span>
    <span class="token function">addCount</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> binCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><ol><li>使用spread方法得到key的hash<br>源码<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> HASH_BITS <span class="token operator">=</span> <span class="token number">0x7fffffff</span><span class="token punctuation">;</span> <span class="token comment">// usable bits of normal node hash</span>

<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">spread</span><span class="token punctuation">(</span><span class="token keyword">int</span> h<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>h <span class="token operator">^</span> <span class="token punctuation">(</span>h <span class="token operator">>>></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> HASH_BITS<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>HASH_BITS值0x7FFFFFFF是一个用16进制表示的整型,是整型里面的最大值<br>转换成二进制0111 1111 1111 1111 1111 1111 1111 1111（前31个1代表数值，最高位（32位）是符号位 0代表正数，1代表负数），hashcode值与其按位与会得到一个正数</li><li>尝试添加元素时发现tab为null，则Node数组尚未初始化，此时执行初始化方法initTable<br>源码<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> sizeCtl<span class="token punctuation">;</span>

 <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">initTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> <span class="token keyword">int</span> sc<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> tab<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sc <span class="token operator">=</span> sizeCtl<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// lost initialization race; just spin</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSetInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> SIZECTL<span class="token punctuation">,</span> sc<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> tab<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token punctuation">(</span>sc <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> sc <span class="token operator">:</span> DEFAULT_CAPACITY<span class="token punctuation">;</span>
                    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
                    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    table <span class="token operator">=</span> tab <span class="token operator">=</span> nt<span class="token punctuation">;</span>
                    sc <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token punctuation">(</span>n <span class="token operator">>>></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
                sizeCtl <span class="token operator">=</span> sc<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> tab<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>通过CAS争夺sizeCtl属性控制权，成功将该值设置为-1的线程可执行初始化，其他线程通过Thread.yield()<br>进行等待，直到确认容器初始化完毕，也就是tab数组有了值。初始化完毕时，sizeCtl被设置为下一次扩容的容量阀值，该值为当前容量的0.75（见源码，n为当前容量值。当变量n右移2位，2的-2次方变为0.25n，然后n减去0.25n为0.75n）</li><li>虽然已经初始化了Node数组，但是Key的hash对应的下标位置的节点元素为空，则新建一个Node节点放入该下标位置数组中<br>源码<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token function">tabAt</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">getObjectAcquire</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>i <span class="token operator">&lt;&lt;</span> ASHIFT<span class="token punctuation">)</span> <span class="token operator">+</span> ABASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
 
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">boolean</span> <span class="token function">casTabAt</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span>
                                     <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> c<span class="token punctuation">,</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">return</span> <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSetObject</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>i <span class="token operator">&lt;&lt;</span> ASHIFT<span class="token punctuation">)</span> <span class="token operator">+</span> ABASE<span class="token punctuation">,</span> c<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>tabAt方法通过计算对应下标位置在数组中的偏移量值，即((long)i &lt;&lt; ASHIFT) +<br>ABASE，基础偏移量+元素间隔偏移量。且读取时使用的是getObjectVolatile方法，该方法的读取和对属性使用volatile是一样效果，保证读取到最新值<br>casTabAt方法在下标位置的节点元素为空时，写入采用了compareAndSetObject方法，目的也是为了保证并发安全性。若CAS成功，则元素添加完毕，可以直接退出循环。若失败，则意味着有其他线程已经对相同的下标位置操作成功，此时就要重新循环，确认最新情况，就是步骤4</li><li>对应Node不为空，且其hash标识为特定负数，也就是标识容器正在扩容的负数MOVED，此时需要协助进行容器扩容<br>由于key的hash会经过方法spread处理，因此必然为正数。而负数的hash有三个特殊的含义(源码中有定义，见下)<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MOVED     <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// hash for forwarding nodes</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> TREEBIN   <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// hash for roots of trees</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> RESERVED  <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// hash for transient reservations</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></li></ol><ul><li>-1: 代表容器正在扩容，且当前节点数据已前移到扩容后的数组中</li><li>-2: 代表当前下标位置上的Node节点采用红黑树结构存储</li><li>-3: 代表该Node节点正在进行函数式运算，值还未最终确定<br>关于扩容和协助扩容，下文会详细记述，这里只需记住协助扩容的触发条件是hash标识为MOVED即可</li></ul><ol start="5"><li>这里是真正开始执行元素添加的操作，分为两步来说<ul><li>节点的hash值不小于0，则遍历链表更新节点或插入新节点。类似HashMap章节所述，判断节点中的key和value是否和要添加的键值对相同，如果不同就添加到链表尾部（尾插法）。重复，则依据方法入参onlyIfAbsent的值判断是否要进行覆盖</li><li>如果是TreeBin类型节点，说明是红黑树，则通过putTreeVal方法往红黑树中插入节点（红黑树会在之后章节具体说明，这里只需要明白是插入树型节点即可）</li></ul></li><li>采用链表存储节点，且链表长度超过阀值8，则将链表转化为红黑树(树化)。见源码注释6，binCount不为0，说明put操作对数据产生影响，在当前链表个数大于等于阈值8时，通过treeifyBin方法转化为红黑树。接着判断oldVal是否不为空，不为空说明是更新操作，不会让元素个数产生变化，则直接返回旧的value</li><li>容器内元素总数+1，并在需要时执行扩容。调用addCount方法尝试更新元素个数baseCount</li></ol><h3 id="扩容和协助扩容操作"><a href="#扩容和协助扩容操作" class="headerlink" title="扩容和协助扩容操作"></a>扩容和协助扩容操作</h3><p>扩容和协助扩容操作其实就在前述注释7这个addCount方法里，但是这个方法看名字其实是对Node数组的元素个数进行更新操作。所以我先把整个addCount方法源码分析一下</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">addCount</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> check<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">CounterCell</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cs<span class="token punctuation">;</span> <span class="token keyword">long</span> b<span class="token punctuation">,</span> s<span class="token punctuation">;</span>
    <span class="token comment">//1. 元素个数更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cs <span class="token operator">=</span> counterCells<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span>
        <span class="token operator">!</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSetLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> BASECOUNT<span class="token punctuation">,</span> b <span class="token operator">=</span> baseCount<span class="token punctuation">,</span> s <span class="token operator">=</span> b <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">CounterCell</span> c<span class="token punctuation">;</span> <span class="token keyword">long</span> v<span class="token punctuation">;</span> <span class="token keyword">int</span> m<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> uncontended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cs <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> cs<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span>c <span class="token operator">=</span> cs<span class="token punctuation">[</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">getProbe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
            <span class="token operator">!</span><span class="token punctuation">(</span>uncontended <span class="token operator">=</span>
              <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSetLong</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> CELLVALUE<span class="token punctuation">,</span> v <span class="token operator">=</span> c<span class="token punctuation">.</span>value<span class="token punctuation">,</span> v <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">fullAddCount</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> uncontended<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>check <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        s <span class="token operator">=</span> <span class="token function">sumCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//2. 扩容判断，true就开始真正的扩容</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>check <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> nt<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> sc<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>s <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>sc <span class="token operator">=</span> sizeCtl<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
               <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&lt;</span> MAXIMUM_CAPACITY<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">resizeStamp</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 2.1 计算盖戳标记值</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//2.2 协助扩容</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sc <span class="token operator">>>></span> RESIZE_STAMP_SHIFT<span class="token punctuation">)</span> <span class="token operator">!=</span> rs <span class="token operator">||</span> sc <span class="token operator">==</span> rs <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">||</span>
                    sc <span class="token operator">==</span> rs <span class="token operator">+</span> MAX_RESIZERS <span class="token operator">||</span> <span class="token punctuation">(</span>nt <span class="token operator">=</span> nextTable<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span>
                    transferIndex <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSetInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> SIZECTL<span class="token punctuation">,</span> sc<span class="token punctuation">,</span> sc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token function">transfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> nt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">// 2.3 扩容</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSetInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> SIZECTL<span class="token punctuation">,</span> sc<span class="token punctuation">,</span>
                                         <span class="token punctuation">(</span>rs <span class="token operator">&lt;&lt;</span> RESIZE_STAMP_SHIFT<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">transfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            s <span class="token operator">=</span> <span class="token function">sumCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><p>如上源码可知这个addCount方法分为两大部分</p><ol><li>整体更新思路实际上和java8新增的一个统计类完全一致的，即<code>java.util.concurrent.atomic. LongAdder</code>。这个类用于在更高的并发竞争下，降低或维持数字计算的延迟。其性能比传统的AtomicLong更好。介绍一下核心思路</li></ol><ul><li>整个统计的数据结构包含一个基本的长整形变量baseCount和一个统计单元CounterCell构成的数组，数组长度为2的幂，初始长度为2，最大长度超过CPU内核数时停止扩容</li><li>当统计数字需要变化时，优先在baseCount上执行CAS操作。如果成功，意味着更新完成。如果失败，说明此时有多线程竞争，放弃在baseCount上的争夺</li><li>当放弃在baseCount上的争夺时，通过线程上的随机数h在CounterCell数组上找到下标位置，在此位置上的CounterCell内部的整型变量上循环执行CAS更新，直到成功</li><li>如果需要初始化CounterCell数组或者添加元素到具体下标位置，或者扩容，那就只能一个线程进行，该线程需要对cellBusy这个属性进行CAS争夺并成功<br>核心思路就是避免多线程在一个变量上循环CAS直到成功。因为当多线程竞争较为激烈时，大量的线程会在不断的<br>CAS失败中浪费很多CPU时间。通过线程变量的方法，将多线程分散到不同的CounterCell元素中，降低竞争激烈程度和颗粒度，从而提高并发效率。<br>由于统计数据被分散在baseCount和CounterCell数组中，执行总数计算时也需要遍历这里面所有的值相加才能得到最终值。接着就是扩容判断环节</li></ul><ol start="2"><li>扩容依据是sizeCtl，当容器元素总数超过sizeCtl时，执行扩容流程(见源码中while循环判断条件)<br>2.1 对当前数组长度计算盖戳标记值，也就是resizeStamp方法，其具体代码如下<div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">resizeStamp</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">numberOfLeadingZeros</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>RESIZE_STAMP_BITS <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div>注释1中说数组长度n是2的幂，<code>Integer.numberOfLeadingZeros(n)</code>获得32位整型数字中，在第一个1之前有多少个0的结果，因此这个值实际上是数字n的一种换算关系<br><code>RESIZE_STAMP_BITS</code>则意味着该结果能够占据的比特位数。由于<code>Integer.numberOfLeadingZeros(n)</code>最大值为27（n的最小值为16），因此<code>RESIZE_STAMP_BITS</code>最小也必须为6。<br>这个方法计算出来的结果，实际上可看成是数组长度的固定换算值。这个值可在扩容过程用于判断是否扩容完毕<br>开始判断是执行扩容还是协助扩容操作。如果sizeCtl当前值为负数，就协助扩容也就是注释2.2；如果为正数，就扩容，也就是注释2.3<br>这里要说明一下sizeCtl</li></ol><ul><li>0: 初始值，意味着此时数组尚未初始化</li><li>-1: 控制值，意味着有线程取得了数组的初始化权利，并且正在执行初始化中</li><li>正数: 要扩容的阀值，一旦元素总数到达该值，则应该进行扩容。除非数组长度到达上限</li><li>非-1的负数: 意味着当前数组正在扩容，该值左边RESIZE_STAMP_BITS个数的比特位用于存储数组长度n的盖戳标记，右边32-RESIZE_STAMP_BITS位用于存储当前参与扩容的线程数<br>2.2 先看源码中第一个if判断 <code>(sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs</code>意味着数组长度已经发生变化，扩容可能已结束，不需要协助。<code>transferIndex &lt;= 0</code><br>意味着原始数组已无可分配的扩容区域，不需要协助。<br><code>sc == rs + 1 || sc == rs + MAX_RESIZERS</code><br>这个条件永远不会达成，属于bug。具体可看 <a target="_blank" rel="noopener" href="https://bugs.java.com/bugdatabase/view_bug.do?bug_id=8214427">JDK-8214427: probable bug in logic of ConcurrentHashMap.addCount()</a> (java12版本已修复)<br>如果确认需要协助，就到第二个if。<code>if (U.compareAndSetInt(this, SIZECTL, sc, sc + 1))</code>通过 CAS增加了一个协助线程数量，然后执行transfer迁移方法<br>2.3 通过CAS对sizeCtl值进行置换。扩容时需要置换的值含义上面也说过（正数），左边是盖戳标记，右边是参与扩容的线程数</li></ul><p>老实说put和扩容以及协助扩容操作代码比较深奥，个人以为面试不会考的这么细致，但是最好记住步骤和这样执行的目的，特别是何时CAS，何时Synchronize以及sizeCtl和计算得出的hash的正负数含义是什么这些</p><h3 id="get操作-1"><a href="#get操作-1" class="headerlink" title="get操作"></a>get操作</h3><p>先看一下get操作源码</p><div class="code-wrapper"><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">></span></span> e<span class="token punctuation">,</span> p<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> eh<span class="token punctuation">;</span> <span class="token class-name">K</span> ek<span class="token punctuation">;</span>
    <span class="token comment">//1.使用spread方法得到key的hash</span>
    <span class="token keyword">int</span> h <span class="token operator">=</span> <span class="token function">spread</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2. 判断数组是否为空，不为空根据hash值确定Node节点位置  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>e <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//3. 如果搜索到的Node节点key与传入的key相同且不为null,直接返回节点的value</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>eh <span class="token operator">=</span> e<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> h<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>ek <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//4. 如果eh&lt;0，说明Node节点在红黑树上，直接查询  </span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>eh <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> p<span class="token punctuation">.</span>val <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">//5. 否则遍历链表，找到对应的值并返回  </span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>ek <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><ol><li>和put操作第一步相同，不再记述</li><li>先判断tab数组是否为空，不为空再用tabAt方法，根据hash值确定Node节点位置</li><li>判断找到的Node节点的hash值是否和key的hash值相同，再判断key相同且不为null，返回该节点的value</li><li>eh小于0，则说明节点在红黑树上，去那边查询(红黑树搜索，添加会另外记述，这里不作更多说明)</li><li>否则遍历链表，找到对应的Node节点的value</li></ol><h1 id="追命三问"><a href="#追命三问" class="headerlink" title="追命三问"></a>追命三问</h1><h2 id="ConcurrentHashMap为啥比Collections-synchronizedMap-读写性能更加好？"><a href="#ConcurrentHashMap为啥比Collections-synchronizedMap-读写性能更加好？" class="headerlink" title="ConcurrentHashMap为啥比Collections.synchronizedMap()读写性能更加好？"></a><code>ConcurrentHashMap</code>为啥比<code>Collections.synchronizedMap()</code>读写性能更加好？</h2><p>网上有人做了测试，发现同样进行put，get操作，<code>ConcurrentHashMap</code>性能都比<code>Collections.synchronizedMap()</code>好，那么为啥呢？</p><ul><li><p>put操作<br><code>Collections.synchronizedMap()</code>的put封装了<code>HashMap</code>的put方法，并加上互斥锁保证安全性。java8之后的<code>ConcurrentHashMap</code>取消了segments分段锁，采用<code>transient volatile Node&lt;K,V&gt;[] table;</code>保存数据。这样对每个Node数组元素加锁，见put操作源码中<code>synchronized(f)</code>,可减少并发冲突概率，提高并发性能。所以<code>ConcurrentHashMap</code>的put并发性更好</p></li><li><p>get操作<br><code>Collections.synchronizedMap()</code>同样封装了HashMap的get方法并加了同步锁。从前述<code>ConcurrentHashMap</code>的get操作源码可知。get操作全程并没有加锁，所以性能上优于<code>Collections.synchronizedMap()</code>的get方法</p></li></ul><p>那么问题来了</p><h2 id="ConcurrentHashMap的get操作为啥不需要加锁？"><a href="#ConcurrentHashMap的get操作为啥不需要加锁？" class="headerlink" title="ConcurrentHashMap的get操作为啥不需要加锁？"></a><code>ConcurrentHashMap</code>的get操作为啥不需要加锁？</h2><p>原因是Node的元素val和指针next是用volatile修饰的，在多线程环境下线程A修改Node结点的val或新增节点时是对线程B可见（见<a href="4266433718.html">volatile</a>章节）</p><p>Node源码中修饰val和next内容如下图红框所示（Node类在<code>ConcurrentHashMap</code>类源码中）</p><p><img src="/img/ConcurrentHashMap/03A3CB77-402C-4536-8886-BFC2E72A2059.png" srcset="/img/loading.gif" lazyload alt="Node源码中修饰val和next内容"></p><p>另外有人说还和Node数组被修饰为volatile关键字有关，见下图<code>ConcurrentHashMap</code>类源码中，Node数组定义代码</p><p><img src="/img/ConcurrentHashMap/1DFD2EBF-F76F-4901-AC2C-7DECDE4DF463.png" srcset="/img/loading.gif" lazyload alt="volatile关键字修饰"></p><p>但其实这是错误的说法，volatile的确可以修饰数组，但修饰的是数组地址。</p><p>比如，<code>volatile int myArray[100]</code>是指myArray地址是volatile的而不是数组元素值是volatile</p><p>那么问题又来了</p><h2 id="ConcurrentHashMap中的Node数组被修饰为volatile的目的是啥？"><a href="#ConcurrentHashMap中的Node数组被修饰为volatile的目的是啥？" class="headerlink" title="ConcurrentHashMap中的Node数组被修饰为volatile的目的是啥？"></a>ConcurrentHashMap中的Node数组被修饰为volatile的目的是啥？</h2><p>答案: <strong>为了扩容！！！</strong></p><p>当Node数组扩容时，可以对其他线程具有可见性，所以加了volatile</p><h2 id="三问答案简易版"><a href="#三问答案简易版" class="headerlink" title="三问答案简易版"></a>三问答案简易版</h2><ol><li>java8中的<code>ConcurrentHashMap</code>，它的get操作，全程不需要加锁，这也是比<code>hashtable</code>、用<code>Collections.synchronizedMap()</code>封装的hashmap这些集合类读写性能好的原因之一</li><li>get操作全程不需要加锁是因为Node的成员val和指针next是用volatile修饰的。和用volatile修饰的Node数组没关系</li><li>数组用volatile修饰主要是为了能在数组扩容时,保证可见性</li></ol><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h2 id="版本区别"><a href="#版本区别" class="headerlink" title="版本区别"></a>版本区别</h2><p>JAVA8之前主要采用锁机制，对某个Segment进行操作时，锁定该Segment，不允许对其进行非查询操作，而JAVA8之后是对每个Node数组中的元素，即Node节点采用CAS无锁算法操作，这种操作在完成前进行判断，如果符合预期结果才给予执行，对并发操作提供了良好的优化</p><h3 id="为啥java8开始放弃Segment？"><a href="#为啥java8开始放弃Segment？" class="headerlink" title="为啥java8开始放弃Segment？"></a>为啥java8开始放弃Segment？</h3><p>根本原因在于java7中的Segment继承ReentrantLock，使用了显示锁，在其实例方法中，每个更新操作内部又使用Unsafe来处理更新。这显然是一种浪费。显示锁、Unsafe这二者都可保证对对象的原子操作。使用一个就行了。但是java8中，Segment还是予以了保留，仅用来处理对象流的读写</p><h2 id="和其它类型的区别"><a href="#和其它类型的区别" class="headerlink" title="和其它类型的区别"></a>和其它类型的区别</h2><p>见表格</p><table><thead><tr><th align="left">类名</th><th align="left">key</th><th align="left">value</th><th align="left">父类</th><th align="left">是否线程安全</th></tr></thead><tbody><tr><td align="left">ConcurrentHashMap</td><td align="left">不允许为null</td><td align="left">不允许为null</td><td align="left">AbstractMap</td><td align="left">安全</td></tr><tr><td align="left">HashMap</td><td align="left">允许为null</td><td align="left">允许为null</td><td align="left">AbstractMap</td><td align="left">不安全</td></tr><tr><td align="left">TreeMap</td><td align="left">不允许为null</td><td align="left">允许为null</td><td align="left">AbstractMap</td><td align="left">不安全</td></tr><tr><td align="left">Hashtable</td><td align="left">不允许为null</td><td align="left">不允许为null</td><td align="left">Dictionary</td><td align="left">安全</td></tr></tbody></table><h3 id="和Hashtable在实现线程安全上的区别"><a href="#和Hashtable在实现线程安全上的区别" class="headerlink" title="和Hashtable在实现线程安全上的区别"></a>和Hashtable在实现线程安全上的区别</h3><ul><li><p>ConcurrentHashMap<br>java8之前，ConcurrentHashMap对整个数组进行了分段(Segment)，每一把锁只锁其中一部分数据，多线程访问不同数据段的数据，不会存在锁竞争，提高并发访问率。（默认分配16个Segment，比Hashtable效率提高16倍。）<br>java8之后，放弃了Segment，直接用Node数组+链表+红黑树来实现，使用synchronized和CAS来并发控制操作。所以看起来就像是优化过且线程安全的HashMap（这也是为啥一开始就说它是线程安全版的HashMap），虽然在java8中还有Segment数据结构，但已简化了属性，只是为了兼容旧版本<br>见ConcurrentHashMap中的Segment源码及其注释<br><img src="/img/ConcurrentHashMap/FDC20221-F22C-4BD3-A57D-B9328E9C7291.png" srcset="/img/loading.gif" lazyload alt="Segment源码及其注释"></p></li><li><p>Hashtable<br>使用synchronized来保证线程安全，效率非常低下。当多个线程访问同步方法时，可能会进入阻塞或轮询状态，若使用put添加元素，另一个线程则不能使用put添加元素，也不能使用get，竞争越激烈效率越低</p></li></ul><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol><li><a target="_blank" rel="noopener" href="https://bugs.java.com/bugdatabase/view_bug.do?bug_id=8214427">JDK-8214427: probable bug in logic of ConcurrentHashMap.addCount()</a></li></ol></div><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/%E7%AE%97%E6%B3%95/">算法</a> <a class="hover-with-bg" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a> <a class="hover-with-bg" href="/tags/Map/">Map</a> <a class="hover-with-bg" href="/tags/ConcurrentHashMap/">ConcurrentHashMap</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p><div class="post-prevnext"><article class="post-prev col-6"><a href="/posts/3730400060.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Set</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/posts/1029785637.html"><span class="hidden-mobile">HashMap</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article class="comments" id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://fastly.jsdelivr.net/npm/valine@1/dist/Valine.min.js",(function(){var i=Object.assign({appId:"AotNUTqXh4KxbyAqtWFR9PH6-gzGzoHsz",appKey:"cqckpd2YjhM5GWX2Ew4tKNyY",path:"window.location.pathname",placeholder:"说点什么吧...",avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!1,recordIP:!0,serverURLs:"",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{Fluid.plugins.initFancyBox("#valine .vcontent img:not(.vemoji)")})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer class="text-center mt-5 py-3"><div class="footer-content"><div style="font-size:.85rem"><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="/js/duration.js"></script></div></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">沪ICP备2022013557号-1</a></span></div></footer><script src="https://fastly.jsdelivr.net/npm/nprogress@0/nprogress.min.js"></script><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/nprogress@0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://fastly.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="https://fastly.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/local-search.js"></script><script src="/js/img-lazyload.js"></script><script src="https://fastly.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js"></script><script src="https://fastly.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="https://fastly.jsdelivr.net/npm/anchor-js@4/anchor.min.js"></script><script defer src="https://fastly.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?29d28856048f5cb020dac5f5c6add7a9";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script src="https://fastly.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://fastly.jsdelivr.net/npm/meting@1.2.0/dist/Meting.min.js"></script><script src="/js/boot.js"></script><script src="/js/backgroundize.js"></script><link defer rel="stylesheet" href="/css/backgroundize.css"><script src="/js/timevalid.js"></script><script src="/js/reward.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"position":"right","width":120,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body></html>